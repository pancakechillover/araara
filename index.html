<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç©ºæ¸¯åŠ æ²¹,.</title>
    <style>
canvas{
  width:100%;
  height:auto; /* é«˜åº¦ç”± JS æŒ‰æ¯”ä¾‹åŠ¨æ€è®¾ç½® */
  display:block;
}

        .color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.10);
            cursor: pointer;
            outline: none;
            transition: border 0.2s;
            margin: 0;
            padding: 0;
        }

        .color-btn.selected {
            border: 2.5px solid #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        }

        @media (max-width: 800px) {
            .split {
                grid-template-columns: 1fr !important;
            }

            .split>.panel {
                min-width: 0 !important;
                width: 100% !important;
                box-sizing: border-box;
            }
        }

        @media (max-width: 600px) {
            .brand {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .brand h1 {
                font-size: 1.2rem;
            }

            .brand .sub {
                font-size: 0.95rem;
                word-break: break-all;
            }

            .logo {
                width: 32px !important;
                height: 32px !important;
                min-width: 32px !important;
                min-height: 32px !important;
            }
        }

        :root {
            /* Dark (default) */
            --bg: #0b0c10;
            --bg2: #07080d;
            --panel: rgba(17, 19, 26, .86);
            --panel2: rgba(15, 17, 23, .72);
            --text: #e9eefc;
            --muted: #a9b3cc;
            --line: rgba(255, 255, 255, .08);
            --accent: #7aa2ff;
            --good: #46d39a;
            --warn: #ffcc66;
            --bad: #ff6b6b;
            --shadow: 0 12px 34px rgba(0, 0, 0, .40);
            --radius: 18px;
            --pad: 14px;
            --font: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Noto Sans CJK SC", sans-serif;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --ringSize: 520px;
            --anim: 140ms;
        }

        body.light {
            /* Light */
            --bg: #f6f7fb;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, .94);
            --panel2: rgba(255, 255, 255, .86);
            --text: #131927;
            --muted: #5a6786;
            --line: #e7eaf3;
            --accent: #3b6cff;
            --good: #1aa772;
            --warn: #c98710;
            --bad: #d43f3f;
            --shadow: 0 12px 28px rgba(10, 20, 40, .12);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: var(--font);
            color: var(--text);
            background:
                radial-gradient(900px 700px at 10% 10%, rgba(122, 162, 255, .18) 0%, transparent 55%),
                radial-gradient(1100px 780px at 90% 0%, rgba(167, 139, 250, .14) 0%, transparent 55%),
                linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* ç»Ÿä¸€æ§ä»¶å­—ä½“ï¼ˆä¿®å¤â€œè¾“å…¥æ•°å­—å­—ä½“ä¸ä¸€æ ·â€è§‚æ„Ÿï¼‰ */
        button,
        input,
        select,
        textarea {
            font-family: var(--font);
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" 1;
        }

        input[type="time"],
        input[type="date"] {
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" 1;
        }

        canvas {
            display: block
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: color-mix(in srgb, var(--bg) 70%, transparent);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border-bottom: 1px solid color-mix(in srgb, var(--line) 90%, transparent);
        }

        body.light header {
            background: rgba(246, 247, 251, .75);
        }

        .topbar {
            max-width: 1280px;
            margin: 0 auto;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .logo {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 92%, #ffffff 8%), #a78bfa);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            position: relative;
            overflow: hidden;
        }

        .logo.red {
            background: linear-gradient(135deg, #ff6b6b 80%, #ffcc66 20%);
            box-shadow: 0 0 0 3px #ff6b6b44, var(--shadow);
            color: #fff;
        }

        .logo.today {
            background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 92%, #ffffff 8%), #a78bfa);
            box-shadow: 0 0 0 3px #7aa2ff44, var(--shadow);
            color: #fff;
        }

        .logo.future {
            background: linear-gradient(135deg, #2563eb 80%, #60a5fa 20%);
            box-shadow: 0 0 0 3px #2563eb44, var(--shadow);
            color: #fff;
        }

        .logo.red {
            background: linear-gradient(135deg, #ff6b6b 80%, #ffcc66 20%);
            box-shadow: 0 0 0 3px #ff6b6b44, var(--shadow);
        }

        .brand h1 {
            font-size: 14px;
            margin: 0;
            letter-spacing: .5px
        }

        .brand .sub {
            font-size: 12px;
            color: var(--muted)
        }

        nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center
        }

        .tab {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 60%, transparent);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            transition: transform var(--anim), background var(--anim), border-color var(--anim);
            -webkit-user-select: none;
            user-select: none;
        }

        .tab:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 82%, transparent)
        }

        .tab.active {
            border-color: color-mix(in srgb, var(--accent) 58%, var(--line));
            background: color-mix(in srgb, var(--accent) 14%, var(--panel2))
        }

        .btn {
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 1px 4px rgba(255, 186, 73, 0.08);
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 12px;
            transition: transform var(--anim), background var(--anim), border-color var(--anim), opacity var(--anim);
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 86%, transparent)
        }

        .btn:active {
            transform: translateY(0px);
            opacity: .9
        }

        .btn.primary {
            border-color: #5c7be0;
            background: color-mix(in srgb, var(--accent) 14%, var(--panel2));
        }



        .btn.danger {
            border-color: #e05c5c;
            background: color-mix(in srgb, var(--bad) 10%, var(--panel2));
            color: #fc0000;
        }

        .btn.good {
            border-color: #3bbf7a;
            background: color-mix(in srgb, var(--good) 10%, var(--panel2))
        }

        .btn.ghost {
            background: transparent
        }

        main {
            max-width: 1280px;
            margin: 0 auto;
            padding: 14px
        }

        .grid {
            display: grid;
            gap: 14px
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .panel .hd {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid color-mix(in srgb, var(--line) 85%, transparent);
            background: color-mix(in srgb, var(--panel2) 65%, transparent);
            gap: 10px;
            flex-wrap: wrap;
        }

        .panel .hd h2 {
            margin: 0;
            font-size: 13px
        }

        .panel .hd .hint {
            color: var(--muted);
            font-size: 12px
        }

        .panel .bd {
            padding: 14px
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .muted {
            color: var(--muted)
        }

        .tiny {
            font-size: 11px;
            color: var(--muted)
        }


        .hr {
            height: 1px;
            background: color-mix(in srgb, var(--line) 85%, transparent);
            margin: 12px 0
        }

        .split {
            display: grid;
            gap: 14px;
            grid-template-columns: var(--ringSize) 1fr;
            align-items: start;
        }

        @media (max-width: 600px) {
            #ring {
                max-width: 100vw;
                height: auto;
            }

            body {
                padding: 0 5px;
            }

            main {
                padding: 5px;
            }
        }

        @media (max-width: 1040px) {
            :root {
                --ringSize: 520px;
            }

            .split {
                grid-template-columns: 1fr
            }
        }

        /* æ—¥å†/æ—¶é—´è½´å³ä¾§åŒº */
        .rightStack {
            display: grid;
            gap: 14px
        }

        /* æ—¥å† */
        .calendar {
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 10px;
        }

        .cal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap
        }

        .cal-title {
            font-size: 13px;
            color: var(--text)
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .dow {
            font-size: 11px;
            color: var(--muted);
            text-align: center;
            padding: 4px 0
        }

        .day {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 12px;
            padding: 8px 6px;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            min-height: 52px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 82%, transparent)
        }

        .day .n {
            font-size: 12px;
            color: var(--text)
        }

        .day.off .n {
            color: #b3b9c9;
        }

        .day.sel {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 12%, var(--panel2))
        }

        .day.today {
            outline: 2px solid #46d39a66;
        }

        .chips {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .chip {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            opacity: .9
        }

        /* æ—¶é—´è½´ */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .entry {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: transform var(--anim), background var(--anim);
        }

        .entry:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 84%, transparent)
        }

        .entry .bar {
            height: 6px
        }

        .entry .ct {
            padding: 10px 10px
        }

        .entry .t {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline
        }

        .entry .t b {
            font-size: 12px
        }

        .entry .t span {
            font-size: 11px;
            color: var(--muted)
        }

        .entry .meta {
            font-size: 11px;
            color: var(--muted);
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            gap: 10px
        }

        /* ä¹ æƒ¯ */
        .habit-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .habit-item {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 14px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform var(--anim), background var(--anim);
        }

        .habit-item:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 84%, transparent)
        }

        .habit-item.sel {
            border-color: color-mix(in srgb, var(--accent) 58%, var(--line));
            background: color-mix(in srgb, var(--accent) 12%, var(--panel2))
        }

        .habit-name {
            font-size: 12px
        }

        .habit-sub {
            font-size: 11px;
            color: var(--muted)
        }

        .ten-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .box {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 12px;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            font-size: 12px;
            transition: transform var(--anim), background var(--anim), border-color var(--anim);
        }

        .box:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 82%, transparent)
        }

        .box.on {
            border-color: color-mix(in srgb, var(--good) 58%, var(--line));
            background: color-mix(in srgb, var(--good) 12%, var(--panel2))
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 820px) {
            .kpi {
                grid-template-columns: 1fr
            }
        }

        .kpi .card {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 14px;
            padding: 10px;
        }

        .kpi .card .v {
            font-size: 18px;
            margin-top: 6px
        }

        .kpi .card .l {
            font-size: 12px;
            color: var(--muted)
        }

        /* ç•ªèŒ„ */
        .pom-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px 18px;
            margin: 24px 0 18px 0;
        }

        @media (max-width: 900px) {
            .pom-grid {
                grid-template-columns: 1fr;
            }
        }


        .pom-card {
            width: 100%;
            margin: 0 auto0 auto;
            background: radial-gradient(900px 700px at 10% 10%, rgba(216, 228, 255, 0.18) 0%, transparent 55%),
                radial-gradient(1100px 780px at 90% 0%, rgba(167, 139, 250, .14) 0%, transparent 55%),
                linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(255, 186, 73, 0.10), 0 1.5px 6px 0 rgba(59, 108, 255, 0.08);
            padding: 22px 18px 18px 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;

            margin: 0 auto;
        }

        .pom-card .pom-title:first-child {
            font-size: 38px;
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .pom-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 2px;
            text-align: center;
        }

        .pom-time {
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .tomatoes {
            line-height: 1.6;
            font-size: 18px;
            word-break: break-all;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px 4px;
            justify-items: center;
        }

        @media (max-width: 600px) {
            .tomatoes {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .pom-summary-card {
            width: 100%;
            margin: 0 0 18px 0;
            background: radial-gradient(900px 700px at 10% 10%, rgba(216, 228, 255, 0.13) 0%, transparent 55%),
                linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(255, 186, 73, 0.08), 0 1.5px 6px 0 rgba(59, 108, 255, 0.06);
            padding: 18px 18px 14px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .pom-summary-title {
            display: grid;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }

        .pom-summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
            width: 100%;
            justify-items: center;
            align-items: stretch;
        }

        @media (max-width: 600px) {
            .pom-summary-row {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 10px;
            }
        }

        .pom-summary-item {
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 14px;
            padding: 10px 16px;
            min-width: 90px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(59, 108, 255, 0.04);
        }

        .pom-summary-label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .pom-summary-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--accent);
        }

        @media (max-width: 600px) {
            .pom-summary-row {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .pom-summary-item {
                min-width: 0;
            }
        }

        /* ç¡çœ ï¼šç®­å¤´æ­¥è¿›å™¨ï¼ˆä¿®å¤â€œæŒ‰ä¸€ä¸‹é¢‘é—ª/éš¾ç”¨â€ï¼‰ */
        .sleep-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            align-items: stretch;
        }

        @media (max-width: 820px) {
            .sleep-grid {
                grid-template-columns: 1fr
            }
        }

        .time-card {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .time-title {
            font-size: 12px
        }

        .time-sub {
            font-size: 11px;
            color: var(--muted)
        }

        .time-stepper {
            display: grid;
            grid-template-columns: 1fr 54px;
            gap: 10px;
            align-items: center;
        }

        .time-display {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--bg2) 65%, transparent);
            border-radius: 16px;
            padding: 14px 14px;
            font-size: 30px;
            letter-spacing: 1px;
            text-align: center;
            -webkit-user-select: none;
            user-select: none;
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--line) 35%, transparent);
            height: 100%;
            /* æ–°å¢ï¼šé«˜åº¦å¡«æ»¡çˆ¶å®¹å™¨ */
            display: flex;
            /* æ–°å¢ï¼šå†…å®¹å±…ä¸­ */
            align-items: center;
            /* æ–°å¢ï¼šå†…å®¹å‚ç›´å±…ä¸­ */
            justify-content: center;
            /* æ–°å¢ï¼šå†…å®¹æ°´å¹³å±…ä¸­ */
        }

        .arrow-col {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .arrow {
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 68%, transparent);
            border-radius: 14px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
            font-size: 16px;
            transition: transform var(--anim), background var(--anim);
            touch-action: manipulation;
        }

        .arrow:hover {
            transform: translateY(-1px);
            background: color-mix(in srgb, var(--panel2) 88%, transparent)
        }

        .arrow:active {
            transform: translateY(0px);
            opacity: .9
        }

        /* ç»Ÿè®¡ */
        .stats-split {
            display: grid;
            grid-template-columns: 390px 1fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 980px) {
            .stats-split {
                grid-template-columns: 1fr
            }
        }

        .seg {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--muted);
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            border-radius: 999px;
            padding: 6px 10px;
        }

        .sw {
            width: 10px;
            height: 10px;
            border-radius: 999px
        }

        /* æ¨¡æ€æ¡† */
        .mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 14px;
            z-index: 50;
        }

        body.light .mask {
            background: rgba(10, 20, 40, .28)
        }

        .mask.show {
            display: flex
        }

        .modal {
            width: min(640px, 100%);
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .modal .mh {
            padding: 12px 14px;
            border-bottom: 1px solid color-mix(in srgb, var(--line) 85%, transparent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .modal .mh b {
            font-size: 13px
        }

        .modal .mb {
            padding: 14px
        }

        .modal .mf {
            padding: 12px 14px;
            border-top: 1px solid color-mix(in srgb, var(--line) 85%, transparent);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        input[type="text"],
        input[type="time"],
        input[type="date"],
        input[type="color"],
        select {
            width: 100%;
            margin-top: 6px;
            padding: 10px 10px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: color-mix(in srgb, var(--panel2) 62%, transparent);
            color: var(--text);
            outline: none;
        }

        input[type="color"] {
            padding: 6px;
            height: 42px
        }

        /* ä¸»é¡µé¢â€œæ”¶èµ·æ—¥å†â€æ•ˆæœï¼šä¿ç•™æ—¥å†æ ‡é¢˜æ ï¼Œä»…éšè—å†…å®¹åŒº */
        #page-home.calendar-collapsed #calendarPanel .bd {
            display: none;
        }
    </style>
</head>

<body>
    <header>

        <div class="topbar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1>ä¸ªäººè®°å½•é¢æ¿</h1>
                    <div class="sub" id="subtitle">é€‰æ‹©æ—¥æœŸåï¼Œå·¦ä¾§å¯æ‹–åŠ¨ç¯å½¢æ—¶é—´è®°å½•æ´»åŠ¨</div>
                </div>
            </div>

            <nav>
                <div class="tab active" data-page="home">ä¸»é¡µé¢</div>
                <div class="tab" data-page="habits">ä¹ æƒ¯ç»Ÿè®¡</div>
                <div class="tab" data-page="pomodoro">ç•ªèŒ„é—¹é’Ÿ</div>
                <div class="tab" data-page="sleep">èµ·åºŠä¸ç¡è§‰</div>
                <div class="tab" data-page="stats">ä»»åŠ¡ç»Ÿè®¡</div>
                <button class="btn" id="dataBtn" title="æ•°æ®å¯¼å…¥/å¯¼å‡ºä¸å­˜æ¡£">ğŸ’¾ æ•°æ®</button>
                <button class="btn" id="themeToggle" title="åˆ‡æ¢æ—¥é—´/å¤œé—´">ğŸŒ™ å¤œé—´</button>
            </nav>
        </div>
    </header>

    <main>
        <!-- ä¸»é¡µé¢ -->
        <section id="page-home" class="grid">
            <div class="split">
                <div class="panel">
                    <div class="hd">
                        <h2>24 å°æ—¶ç¯å½¢æ—¶é—´ï¼ˆå¯ç‚¹å‡»/æ‹–åŠ¨ï¼‰</h2>
                        <div class="row">
                            <button class="btn" id="btnToday">å›åˆ°ä»Šå¤©</button>
                            <button class="btn danger" id="btnClearDay">æ¸…ç©ºå½“æ—¥</button>
                        </div>
                    </div>
                    <div class="bd">
                        <canvas id="ring" width="520" height="520"></canvas>
                        <div class="tiny" style="margin-top:10px">
                            æ“ä½œï¼šåœ¨ç¯ä¸ŠæŒ‰ä¸‹å¹¶æ‹–åŠ¨é€‰æ‹©æ—¶é—´æ®µï¼›æ¾å¼€åå¡«å†™â€œåšäº†ä»€ä¹ˆâ€å’Œâ€œä»»åŠ¡ç±»å‹â€ã€‚è½»ç‚¹é»˜è®¤ 30 åˆ†é’Ÿï¼Œå¯åœ¨å¼¹çª—å†…æ”¹æ—¶é—´ã€‚
                        </div>
                    </div>
                </div>

                <div class="rightStack">
                    <div class="panel" id="calendarPanel">
                        <div class="hd">
                            <h2>æ—¥å†</h2>
                            <div class="row">
                                <div class="hint" id="selDateLabel">â€”</div>
                                <button class="btn" id="calCollapseBtn" style="display:inline-block">æ”¶èµ·æ—¥å†</button>
                                <button class="btn" id="calExpandBtn" style="display:none">å±•å¼€æ—¥å†</button>
                            </div>
                        </div>
                        <div class="bd">
                            <div class="calendar">
                                <div class="cal-head">
                                    <div class="row" style="gap:8px">
                                        <button class="btn" id="calPrev">ä¸Šä¸ªæœˆ</button>
                                        <button class="btn" id="calNext">ä¸‹ä¸ªæœˆ</button>
                                    </div>
                                    <div class="cal-title" id="calTitle">â€”</div>
                                </div>
                                <div class="cal-grid" id="calDow"></div>
                                <div class="cal-grid" id="calGrid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="hd">
                            <h2>å½“å¤©æ—¶é—´è½´</h2>
                            <div class="hint" id="daySummary">â€”</div>
                        </div>
                        <div class="bd">
                            <div class="timeline" id="timeline"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ä¹ æƒ¯ç»Ÿè®¡ -->
        <section id="page-habits" class="grid" style="display:none">
            <div class="split" style="grid-template-columns: 420px 1fr">
                <div class="panel">
                    <div class="hd">
                        <h2>ä¹ æƒ¯åˆ—è¡¨</h2>
                        <button class="btn primary" id="btnAddHabit">æ–°å¢ä¹ æƒ¯</button>
                    </div>
                    <div class="bd">
                        <div class="habit-list" id="habitList"></div>
                        <div class="hr"></div>
                        <div class="tiny">æ¯ä¸ªä¹ æƒ¯ä»¥ 10 å¤©ä¸ºä¸€ä¸ªå¾ªç¯ã€‚å¯åˆ‡æ¢å¾ªç¯æŸ¥çœ‹/å‹¾é€‰å®Œæˆæƒ…å†µã€‚</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="hd">
                        <h2 id="habitTitle">è¯·é€‰æ‹©ä¸€ä¸ªä¹ æƒ¯</h2>
                        <div class="row">
                            <button class="btn" id="cyclePrev">ä¸Šä¸€ä¸ªå¾ªç¯</button>
                            <button class="btn" id="cycleNext">ä¸‹ä¸€ä¸ªå¾ªç¯</button>
                            <button class="btn danger" id="btnDeleteHabit" style="display:none">åˆ é™¤ä¹ æƒ¯</button>
                        </div>
                    </div>
                    <div class="bd">
                        <div id="habitBody" class="muted">ä»å·¦ä¾§é€‰æ‹©ä¹ æƒ¯åï¼Œè¿™é‡Œä¼šå‡ºç° 10 ä¸ªæ–¹æ¡†ä¾›ä½ æ‰“é’©ã€‚</div>

                        <div class="kpi" id="habitKpi" style="display:none">
                            <div class="card">
                                <div class="l">å½“å‰å¾ªç¯å®Œæˆ</div>
                                <div class="v" id="kpiCycle">â€”</div>
                            </div>
                            <div class="card">
                                <div class="l">æ€»ä½“å®Œæˆç‡</div>
                                <div class="v" id="kpiAll">â€”</div>
                            </div>
                            <div class="card">
                                <div class="l">è¿ç»­å®Œæˆå¤©æ•°ï¼ˆè¿‘ä¼¼ï¼‰</div>
                                <div class="v" id="kpiStreak">â€”</div>
                            </div>
                        </div>

                        <div class="hr"></div>
                        <div class="panel panel-transparent">
                            <div class="hd hd-panel-transparent">
                                <h2 class="habit-history-title">å†å²è¶‹åŠ¿</h2>
                                <div class="hint">ä»ä»Šå¤©èµ·ï¼Œè¿‡å»10å¤©</div>
                            </div>
                            <div class="bd habit-history-bd">
                                <canvas id="habitChart" class="habit-history-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç•ªèŒ„é—¹é’Ÿ -->
        <section id="page-pomodoro" class="grid" style="display:none">
            <div class="panel">
                <div class="hd">
                    <h2>å½“æ—¥å®Œæˆç•ªèŒ„é—¹é’Ÿç»Ÿè®¡</h2>
                    <div class="row">
                        <button class="btn" id="pomToday">å›åˆ°ä»Šå¤©</button>
                        <button class="btn danger" id="pomClear">æ¸…ç©ºå½“æ—¥</button>
                    </div>
                </div>
                <div class="bd">
                    <div class="row" style="justify-content:space-between; align-items:flex-end; width:100%;">
                        <div class="col">
                            <div class="muted">å½“å‰æ—¥æœŸ</div>
                            <div style="font-size:16px; cursor:pointer;" id="pomDateLabel">â€”
                            </div>
                            <!-- ç•ªèŒ„é’Ÿæ—¥æœŸé€‰æ‹©å¼¹çª— -->
                            <div class="mask" id="pomDateMask">
                                <div class="modal" role="dialog" aria-modal="true" aria-label="é€‰æ‹©æ—¥æœŸ">
                                    <div class="mh">
                                        <b>é€‰æ‹©æ—¥æœŸ</b>
                                        <button class="btn" id="pomDateClose">å…³é—­</button>
                                    </div>
                                    <div class="mb">
                                        <input type="date" id="pomDatePicker" style="font-size:18px;padding:8px;" />
                                    </div>
                                    <div class="mf">
                                        <button class="btn primary" id="pomDateOk">ç¡®å®š</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="gap:8px; align-items:flex-end;">
                            <button class="btn" id="pomPrevDay">å‰ä¸€å¤©</button>
                            <button class="btn" id="pomNextDay">åä¸€å¤©</button>
                        </div>
                    </div>

                    <div class="hr"></div>

                    <div class="pom-grid">
                        <div class="pom-card">
                            <div>
                                <div class="pom-title">ğŸŒ…</div>
                                <div class="pom-title">æ—©æ™¨</div>
                                <div class="pom-time">08:00â€“12:00</div>
                            </div>
                            <div class="step">
                                <button class="btn" data-pom="morning" data-delta="-1">ï¼</button>
                                <div class="pill" id="pom_morning_n">0</div>
                                <button class="btn" data-pom="morning" data-delta="1">ï¼‹</button>
                            </div>
                            <div class="tomatoes" id="pom_morning"></div>
                        </div>

                        <div class="pom-card">
                            <div>
                                <div class="pom-title">â˜€ï¸</div>
                                <div class="pom-title">ä¸­åˆ</div>
                                <div class="pom-time">14:00â€“18:00</div>
                            </div>
                            <div class="step">
                                <button class="btn" data-pom="noon" data-delta="-1">ï¼</button>
                                <div class="pill" id="pom_noon_n">0</div>
                                <button class="btn" data-pom="noon" data-delta="1">ï¼‹</button>
                            </div>
                            <div class="tomatoes" id="pom_noon"></div>
                        </div>

                        <div class="pom-card">
                            <div>
                                <div class="pom-title">ğŸŒ™</div>
                                <div class="pom-title">æ™šä¸Š</div>
                                <div class="pom-time">20:00â€“24:00</div>
                            </div>
                            <div class="step">
                                <button class="btn" data-pom="evening" data-delta="-1">ï¼</button>
                                <div class="pill" id="pom_evening_n">0</div>
                                <button class="btn" data-pom="evening" data-delta="1">ï¼‹</button>
                            </div>
                            <div class="tomatoes" id="pom_evening"></div>
                        </div>
                    </div>
                    <div class="pom-summary-card" id="pomSummaryCard">
                        <div class="pom-summary-title">ğŸ… ä»Šæ—¥æ€»ç»“</div>
                        <div class="pom-summary-row">
                            <div class="pom-summary-item">
                                <div class="pom-summary-label">æ€»ç•ªèŒ„æ•°</div>
                                <div class="pom-summary-value" id="pomSummaryTotal" style="color:rgb(248, 101, 33)">â€”
                                </div>
                            </div>
                            <div class="pom-summary-item">
                                <div class="pom-summary-label">ä¸“æ³¨å°æ—¶</div>
                                <div class="pom-summary-value" id="pomSummaryHour" style="color:rgb(225, 213, 50);">â€”
                                </div>
                            </div>
                            <div class="pom-summary-item">
                                <div class="pom-summary-label">æ•ˆç‡åˆ†æ•°</div>
                                <div class="pom-summary-value" id="pomSummaryScore" style="color:rgb(83, 157, 253);">â€”
                                </div>
                            </div>
                            <div class="pom-summary-item">
                                <div class="pom-summary-label">æœ€ä½³æ—¶æ®µ</div>
                                <div class="pom-summary-value" id="pomSummaryBest">â€”</div>
                            </div>
                        </div>
                    </div>
                    <div class="hr"></div>

                    <div class="panel panel-transparent">
                        <div class="hd hd-panel-transparent">
                            <h2 class="h2-small">ç»Ÿè®¡å›¾</h2>
                            <div class="hint" id="pomTotalHint">ä»ä»Šå¤©èµ·ï¼Œè¿‡å»10å¤©</div>
                        </div>
                        <div class="bd bd-no-padding">
                            <canvas id="pomChart" width="900" height="400"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- èµ·åºŠä¸ç¡è§‰ -->
        <section id="page-sleep" class="grid" style="display:none">
            <div class="panel">
                <div class="hd">
                    <h2>è®°å½•èµ·åºŠä¸å…¥ç¡æ—¶é—´ï¼ˆè®°å¾—ï¼ŒæŒ‰ï¼Œä¿å­˜ã€‚ã€‚ï¼‰</h2>
                    <div class="row">
                        <button class="btn" id="sleepToday">å›åˆ°ä»Šå¤©</button>
                        <button class="btn danger" id="sleepClear">æ¸…ç©ºå½“æ—¥</button>
                    </div>
                </div>
                <div class="bd">
                    <div class="row" style="justify-content:space-between; align-items:flex-end">
                        <div class="col">
                            <div class="muted">å½“å‰æ—¥æœŸ</div>
                            <div style="font-size:16px" id="sleepDateLabel">â€”</div>
                        </div>
                        <div class="row" style="gap:8px">
                            <button class="btn" id="sleepPrevDay">å‰ä¸€å¤©</button>
                            <button class="btn" id="sleepNextDay">åä¸€å¤©</button>
                        </div>
                    </div>

                    <div class="hr"></div>

                    <div class="sleep-grid">
                        <div class="time-card">
                            <div>
                                <div class="time-title">èµ·åºŠæ—¶é—´</div>
                                <div class="time-sub">è½»ç‚¹ï¼šæ­¥è¿› 5 åˆ†é’Ÿï¼›é•¿æŒ‰ï¼šè¿ç»­è°ƒæ•´</div>
                            </div>
                            <div class="time-stepper">
                                <div class="time-display" id="wakeDisp">07:30</div>
                                <div class="arrow-col">
                                    <div class="arrow" id="wakeUp">â–²</div>
                                    <div class="arrow" id="wakeDown">â–¼</div>
                                </div>
                            </div>
                        </div>

                        <div class="time-card">
                            <div>
                                <div class="time-title">å…¥ç¡æ—¶é—´</div>
                                <div class="time-sub">ä¸€èˆ¬åœ¨å½“æ—¥å¤œé—´ï¼›è‹¥è·¨å¤©è§†ä½œâ€œå½“æ—¥æ™šç¡â€</div>
                            </div>
                            <div class="time-stepper">
                                <div class="time-display" id="bedDisp">23:30</div>
                                <div class="arrow-col">
                                    <div class="arrow" id="bedUp">â–²</div>
                                    <div class="arrow" id="bedDown">â–¼</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" style="justify-content:flex-end; margin-top:12px">
                        <button class="btn primary" id="sleepSave">ä¿å­˜</button>
                    </div>

                    <div class="kpi" style="margin-top:14px">
                        <div class="card">
                            <div class="l">å½“æ—¥ç¡çœ æ—¶é•¿ï¼ˆä¼°ç®—ï¼‰</div>
                            <div class="v" id="sleepDur">â€”</div>
                        </div>
                        <div class="card">
                            <div class="l">æœ€è¿‘ 7 å¤©å¹³å‡ç¡çœ æ—¶é•¿</div>
                            <div class="v" id="sleepAvg7">â€”</div>
                        </div>
                        <div class="card">
                            <div class="l">æœ€è¿‘ 7 å¤©å¹³å‡èµ·åºŠ / å…¥ç¡</div>
                            <div class="v" id="sleepAvgTime">â€”</div>
                        </div>
                    </div>

                    <div class="hr"></div>

                    <div class="panel panel-sleep-transparent">
                        <div class="hd hd-sleep">
                            <h2 class="h2-sleep">ç»Ÿè®¡å›¾ï¼ˆæœ€è¿‘ 14 å¤©ç¡çœ æ—¶é•¿ï¼‰</h2>
                            <div class="hint">ä»…ç»Ÿè®¡å·²å¡«å†™èµ·åºŠä¸å…¥ç¡æ—¶é—´çš„æ—¥æœŸ</div>
                        </div>
                        <div class="bd bd-sleep">
                            <canvas id="sleepChart" width="900" height="400"></canvas>
                        </div>
                    </div>

                    <div class="panel panel-sleep-transparent panel-sleep-margin">
                        <div class="hd hd-sleep">
                            <h2 class="h2-sleep">å…¥ç¡/èµ·åºŠæ—¶é—´è¶‹åŠ¿ï¼ˆæœ€è¿‘ 14 å¤©ï¼‰</h2>
                            <div class="hint">æ¨ªè½´ä¸ºæ—¥æœŸï¼Œçºµè½´ä¸ºå°æ—¶ï¼Œç»¿è‰²=èµ·åºŠï¼Œç´«è‰²=å…¥ç¡</div>
                        </div>
                        <div class="bd bd-sleep">
                            <canvas id="sleepTimeLineChart" width="900" height="500"></canvas>
                        </div>
                    </div>
                </div>
        </section>

        <!-- ä»»åŠ¡ç»Ÿè®¡ -->
        <section id="page-stats" class="grid" style="display:none">
            <div class="stats-split">
                <div class="panel">
                    <div class="hd">
                        <h2>ç»Ÿè®¡è®¾ç½®</h2>
                        <div class="hint">æ´»åŠ¨æ¥è‡ªä¸»é¡µé¢â€œä»»åŠ¡ç±»å‹â€</div>
                    </div>
                    <div class="bd">
                        <div class="muted">ç»Ÿè®¡æ¨¡å¼</div>
                        <div class="seg" id="statsModeSeg" style="margin-top:8px">
                            <div class="tab active" data-stats-mode="byday">æŒ‰å¤©</div>
                            <div class="tab" data-stats-mode="bycat">æŒ‰ç±»åˆ«</div>
                        </div>

                        <div class="hr"></div>

                        <div class="col" style="gap:8px">
                            <div class="muted">æ—¶é—´èŒƒå›´</div>
                            <select id="statsRange">
                                <option value="7">æœ€è¿‘ 7 å¤©</option>
                                <option value="14" selected>æœ€è¿‘ 14 å¤©</option>
                                <option value="30">æœ€è¿‘ 30 å¤©</option>
                            </select>

                            <div class="muted" style="margin-top:6px">ï¼ˆæŒ‰å¤©æ¨¡å¼ï¼‰é€‰æ‹©ä»»åŠ¡ç±»åˆ«</div>
                            <select id="statsCategory"></select>

                            <div class="hr"></div>

                            <div class="muted">ï¼ˆæŒ‰å¤©æ¨¡å¼ï¼‰é¥¼å›¾æ—¥æœŸ</div>
                            <div class="row justify-space-between">
                                <button class="btn" id="statsPrevDay">å‰ä¸€å¤©</button>
                                <div class="pill min-width-140" id="statsDayLabel">â€”</div>
                                <button class="btn" id="statsNextDay">åä¸€å¤©</button>
                            </div>

                            <div class="row justify-flex-end margin-top-8">
                                <button class="btn" id="statsUseSelected">ç”¨å½“å‰é€‰ä¸­æ—¥æœŸ</button>
                                <button class="btn primary" id="statsRefresh">åˆ·æ–°</button>
                            </div>
                        </div>

                        <div class="hr"></div>
                        <div class="muted">å›¾ä¾‹</div>
                        <div class="legend margin-top-8" id="statsLegend"></div>
                    </div>
                </div>

                <div class="grid">
                    <div class="panel">
                        <div class="hd">
                            <h2 id="statsTitle">æŒ‰å¤©ç»Ÿè®¡</h2>
                            <div class="hint" id="statsHint">â€”</div>
                        </div>
                        <div class="bd">
                            <canvas id="statsBar" width="900" height="260"></canvas>
                            <div class="tiny margin-top-10">æç¤ºï¼šæŒ‰å¤©æŸ±çŠ¶å›¾å¯ç‚¹å‡»æŸä¸€å¤©æ¥åˆ‡æ¢é¥¼å›¾æ—¥æœŸã€‚</div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="hd">
                            <h2 id="statsPieTitle">å½“æ—¥ç±»åˆ«åˆ†å¸ƒ</h2>
                            <div class="hint" id="statsPieHint">â€”</div>
                        </div>
                        <div class="bd">
                            <canvas id="statsPie" width="900" height="260"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- æ´»åŠ¨ç¼–è¾‘å¼¹çª— -->
    <div class="mask" id="mask">
        <div class="modal" role="dialog" aria-modal="true" aria-label="ç¼–è¾‘æ´»åŠ¨">
            <div class="mh">
                <b>è®°å½•æ´»åŠ¨</b>
                <button class="btn" id="modalClose">å…³é—­</button>
            </div>
            <div class="mb">
                <div class="grid" style="gap:10px">
                    <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
                        <div>
                            <label>å¼€å§‹æ—¶é—´</label>
                            <input type="time" id="actStart" />
                        </div>
                        <div>
                            <label>ç»“æŸæ—¶é—´</label>
                            <input type="time" id="actEnd" />
                        </div>
                    </div>

                    <div>
                        <label>æ´»åŠ¨åç§°</label>
                        <div
                            style="display:flex; gap:8px; align-items:center; justify-content:flex-start; padding:10px 10px">
                            <span class="sw" id="actTypeSw" style="width:14px;height:14px"></span>
                            <span class="muted" id="actTypeName" style="font-size:13px">â€”</span>
                            <input type="text" id="actLabel" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ ã€è¿åŠ¨ã€åƒé¥­ã€ä¼‘æ¯â€¦"
                                style="flex:1; margin-left:10px;" />
                        </div>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 160px; gap:10px; align-items:end">
                        <div>
                            <label>ä»»åŠ¡ç±»å‹</label>
                            <select id="actType"></select>
                            <div class="tiny" style="margin-top:6px">
                                æ²¡æœ‰åˆé€‚ç±»å‹ï¼Ÿ<button class="btn" id="btnQuickAddType" style="padding:6px 10px">ï¼‹ æ–°å»ºç±»å‹</button>
                            </div>
                        </div>
                        <div>
                        </div>
                    </div>

                    <div class="tiny">
                        æç¤ºï¼šé»˜è®¤ä¸æ”¯æŒè·¨å¤©ï¼ˆç»“æŸæ—¶é—´éœ€è¦æ™šäºå¼€å§‹æ—¶é—´ï¼‰ã€‚è·¨å¤©å»ºè®®æ‹†æˆä¸¤æ®µè®°å½•ã€‚
                    </div>
                </div>
            </div>
            <div class="mf">
                <button class="btn danger" id="modalDelete" style="display:none">åˆ é™¤è¿™ä¸€æ¡</button>
                <button class="btn" id="modalCancel">å–æ¶ˆ</button>
                <button class="btn primary" id="modalSave">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ä¹ æƒ¯å¼¹çª— -->
    <div class="mask" id="habitMask">
        <div class="modal" role="dialog" aria-modal="true" aria-label="æ–°å¢ä¹ æƒ¯">
            <div class="mh">
                <b>æ–°å¢ä¹ æƒ¯</b>
                <button class="btn" id="habitClose">å…³é—­</button>
            </div>
            <div class="mb">
                <div class="grid" style="gap:10px">
                    <div>
                        <label>ä¹ æƒ¯åç§°</label>
                        <input type="text" id="habitName" placeholder="ä¾‹å¦‚ï¼šæ—©ç¡ã€èƒŒå•è¯ã€è·‘æ­¥â€¦" />
                    </div>
                    <div>
                        <label>å¾ªç¯èµ·å§‹æ—¥æœŸï¼ˆä»è¿™ä¸€å¤©å¼€å§‹æŒ‰ 10 å¤©åˆ’åˆ†ï¼‰</label>
                        <input type="date" id="habitStartDate" />
                    </div>
                    <div>
                        <label>é¢œè‰²è®¾ç½®ï¼ˆç”¨ä¸äº†ï¼Œè¿˜æ˜¯é»˜è®¤é¢œè‰²åˆ—è¡¨ï¼Œã€‚ï¼‰</label>
                        <div id="habitColorPicker"
                            style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:2px">
                            <input type="hidden" id="habitColor" value="#7aa2ff">
                            <button type="button" class="color-btn" style="background:#7aa2ff"
                                data-color="#7aa2ff"></button>
                            <button type="button" class="color-btn" style="background:#46d39a"
                                data-color="#46d39a"></button>
                            <button type="button" class="color-btn" style="background:#ffcc66"
                                data-color="#ffcc66"></button>
                            <button type="button" class="color-btn" style="background:#ff6b6b"
                                data-color="#ff6b6b"></button>
                            <button type="button" class="color-btn" style="background:#a78bfa"
                                data-color="#a78bfa"></button>
                            <button type="button" class="color-btn" style="background:#3b6cff"
                                data-color="#3b6cff"></button>
                            <input type="color" id="habitColorCustom"
                                style="width:28px;height:28px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.10);cursor:pointer;outline:none;transition:border 0.2s;margin:0;padding:0;background:none"
                                title="è‡ªå®šä¹‰é¢œè‰²">
                        </div>
                    </div>
                </div>
                <div class="mf">
                    <button class="btn" id="habitCancel">å–æ¶ˆ</button>
                    <button class="btn primary" id="habitCreate">åˆ›å»º</button>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- å¿«é€Ÿæ–°å¢ä»»åŠ¡ç±»å‹å¼¹çª— -->
    <div class="mask" id="typeMask">
        <div class="modal" role="dialog" aria-modal="true" aria-label="æ–°å¢ä»»åŠ¡ç±»å‹">
            <div class="mh">
                <b>æ–°å¢ä»»åŠ¡ç±»å‹</b>
                <button class="btn" id="typeClose">å…³é—­</button>
            </div>
            <div class="mb">
                <div class="grid" style="gap:10px">
                    <div>
                        <label>ç±»å‹åç§°</label>
                        <input type="text" id="typeName" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ ã€å·¥ä½œã€è¿åŠ¨ã€å¨±ä¹â€¦" />
                    </div>
                    <div>
                        <label>å›ºå®šé¢œè‰²</label>
                        <input type="color" id="typeColor" value="#7aa2ff" />
                    </div>
                    <div class="tiny">åˆ›å»ºåå¯åœ¨æ´»åŠ¨ä¸­é€‰æ‹©è¯¥ç±»å‹ï¼›ç»Ÿè®¡ä¹Ÿä¼šæŒ‰ç±»å‹æ±‡æ€»ã€‚</div>
                </div>
            </div>
            <div class="mf">
                <button class="btn" id="typeCancel">å–æ¶ˆ</button>
                <button class="btn primary" id="typeCreate">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®ï¼šå¯¼å…¥/å¯¼å‡º/å­˜æ¡£å¼¹çª— -->
    <div class="mask" id="dataMask">
        <div class="modal" role="dialog" aria-modal="true" aria-label="æ•°æ®å¯¼å…¥å¯¼å‡º">
            <div class="mh">
                <b>æ•°æ®ä¸å­˜æ¡£</b>
                <button class="btn" id="dataClose">å…³é—­</button>
            </div>
            <div class="mb">
                <div class="grid" style="gap:12px">
                    <div class="panel" style="background:transparent; box-shadow:none">
                        <div class="hd" style="background:transparent">
                            <h2 style="font-size:13px">æ‰‹åŠ¨å¯¼å…¥ / å¯¼å‡º</h2>
                            <div class="hint">é€‚ç”¨äºæ‰€æœ‰æµè§ˆå™¨</div>
                        </div>
                        <div class="bd">
                            <div class="row">
                                <button class="btn primary" id="exportBtn">å¯¼å‡º JSON</button>
                                <label class="btn" style="cursor:pointer">
                                    å¯¼å…¥ JSON
                                    <input id="importFile" type="file" accept="application/json" style="display:none" />
                                </label>
                                <button class="btn danger" id="resetLocalBtn">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
                            </div>
                            <div class="tiny" style="margin-top:8px">
                                å¯¼å…¥ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼ˆä¼šå…ˆå°è¯•å¤‡ä»½ä¸ºä¸‹è½½æ–‡ä»¶ï¼‰ã€‚
                            </div>
                        </div>
                    </div>

                    <div class="panel" style="background:transparent; box-shadow:none">
                        <div class="hd" style="background:transparent">
                            <h2 style="font-size:13px">è‡ªåŠ¨å­˜æ¡£ï¼ˆå¥½åƒç”¨ä¸äº†ï¼Œæˆ‘åŠ›ç«­äº†ï¼‰</h2>
                            <div class="hint">éœ€è¦æµè§ˆå™¨æ”¯æŒ File System Access APIï¼ˆChrome/Edge ç­‰ï¼‰</div>
                        </div>
                        <div class="bd">
                            <div class="row">
                                <button class="btn" id="pickArchiveBtn">é€‰æ‹©/åˆ›å»ºå­˜æ¡£æ–‡ä»¶</button>
                                <button class="btn good" id="syncNowBtn">ç«‹å³åŒæ­¥</button>
                                <button class="btn" id="toggleAutoSyncBtn">è‡ªåŠ¨åŒæ­¥ï¼šå…³</button>
                            </div>
                            <div class="tiny" style="margin-top:8px" id="archiveStatus">
                                çŠ¶æ€ï¼šæœªè®¾ç½®å­˜æ¡£æ–‡ä»¶
                            </div>
                            <div class="tiny" style="margin-top:6px">
                                è¯´æ˜ï¼šç½‘é¡µä¸èƒ½ç›´æ¥è¯»å–â€œä»»æ„æŒ‡å®šè·¯å¾„â€ã€‚ä½ éœ€è¦ç¬¬ä¸€æ¬¡æ‰‹åŠ¨é€‰æ‹©ä¸€ä¸ª JSON æ–‡ä»¶ä½œä¸ºå­˜æ¡£ï¼›ä¹‹åæµè§ˆå™¨ä¼šè®°ä½æˆæƒï¼Œæ‰“å¼€é¡µé¢å³å¯è‡ªåŠ¨è¯»å–å¹¶è‡ªåŠ¨æ›´æ–°è¯¥å­˜æ¡£ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mf">
                <button class="btn" id="dataOk">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        function setCanvasDPI(canvas, dpi=300){
  const rect = canvas.getBoundingClientRect();
  const scale = dpi / 96; // 1in=96 CSS px
  canvas.width  = Math.round(rect.width  * scale);
  canvas.height = Math.round(rect.height * scale);
  const ctx = canvas.getContext("2d");
  ctx.setTransform(scale,0,0,scale,0,0); // åç»­æŒ‰CSSåƒç´ ç”»
}

        // ä¹ æƒ¯é¢œè‰²é€‰æ‹©é€»è¾‘
        document.addEventListener("DOMContentLoaded", function () {
            const colorBtns = document.querySelectorAll("#habitColorPicker .color-btn");
            const colorInput = document.getElementById("habitColor");
            const colorCustom = document.getElementById("habitColorCustom");
            function selectColor(color) {
                colorInput.value = color;
                colorBtns.forEach(btn => {
                    if (btn.dataset.color === color) {
                        btn.classList.add("selected");
                    } else {
                        btn.classList.remove("selected");
                    }
                });
                colorCustom.value = color;
            }
            colorBtns.forEach(btn => {
                btn.addEventListener("click", function () {
                    selectColor(this.dataset.color);
                });
            });
            colorCustom.addEventListener("input", function () {
                selectColor(this.value);
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            selectColor(colorInput.value);
        });
        /* =========================
           é…ç½®ä¸å­˜å‚¨
        ========================= */
        const STORAGE_KEY = "dailyTrackerData_v3";
        const THEME_KEY = "dailyTrackerTheme_v1";
        const UI_KEY = "dailyTrackerUI_v1";
        const SYNC_KEY = "dailyTrackerSync_v1";

        // IndexedDB ä¿å­˜ FileHandleï¼ˆæ”¯æŒç»“æ„åŒ–å…‹éš†ï¼‰
        const IDB_NAME = "dailyTrackerFS";
        const IDB_STORE = "kv";

        function idbOpen() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(IDB_NAME, 1);
                req.onupgradeneeded = () => req.result.createObjectStore(IDB_STORE);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function idbGet(key) {
            const db = await idbOpen();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE, "readonly");
                const st = tx.objectStore(IDB_STORE);
                const req = st.get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function idbSet(key, val) {
            const db = await idbOpen();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE, "readwrite");
                const st = tx.objectStore(IDB_STORE);
                const req = st.put(val, key);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error);
            });
        }
        async function idbDel(key) {
            const db = await idbOpen();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE, "readwrite");
                const st = tx.objectStore(IDB_STORE);
                const req = st.delete(key);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error);
            });
        }

        function loadUI() {
            try {
                return JSON.parse(localStorage.getItem(UI_KEY) || "{}");
            } catch { return {}; }
        }
        function saveUI(u) { localStorage.setItem(UI_KEY, JSON.stringify(u)); }

        function loadSyncCfg() {
            try {
                return JSON.parse(localStorage.getItem(SYNC_KEY) || "{}");
            } catch { return {}; }
        }
        function saveSyncCfg(c) { localStorage.setItem(SYNC_KEY, JSON.stringify(c)); }

        function getCSS(varName) {
            return getComputedStyle(document.body).getPropertyValue(varName).trim();
        }

        function nowYMD() {
            const d = new Date();
            return ymd(d);
        }

        function loadDB() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                const parsed = raw ? JSON.parse(raw) : {};
                parsed.days ||= {};
                parsed.habits ||= { list: [], records: {} };
                parsed.habits.list ||= [];
                parsed.habits.records ||= {};
                parsed.taskTypes ||= { list: [] };

                // é»˜è®¤ä»»åŠ¡ç±»å‹
                if (!parsed.taskTypes.list.length) {
                    parsed.taskTypes.list = [
                        { id: "uncat", name: "æœªåˆ†ç±»", color: getCSS("--accent") || "#7aa2ff", created: nowYMD() },
                        { id: "study", name: "å­¦ä¹ ", color: "#7aa2ff", created: nowYMD() },
                        { id: "work", name: "å·¥ä½œ", color: "#46d39a", created: nowYMD() },
                        { id: "life", name: "ç”Ÿæ´»", color: "#ffcc66", created: nowYMD() },
                    ];
                } else {
                    if (!parsed.taskTypes.list.some(t => t.id === "uncat")) {
                        parsed.taskTypes.list.unshift({ id: "uncat", name: "æœªåˆ†ç±»", color: getCSS("--accent") || "#7aa2ff", created: nowYMD() });
                    }
                }
                return parsed;
            } catch (e) {
                return {
                    days: {},
                    habits: { list: [], records: {} },
                    taskTypes: {
                        list: [
                            { id: "uncat", name: "æœªåˆ†ç±»", color: "#7aa2ff", created: nowYMD() },
                            { id: "study", name: "å­¦ä¹ ", color: "#7aa2ff", created: nowYMD() },
                            { id: "work", name: "å·¥ä½œ", color: "#46d39a", created: nowYMD() },
                            { id: "life", name: "ç”Ÿæ´»", color: "#ffcc66", created: nowYMD() },
                        ]
                    },
                };
            }
        }

        let db = loadDB();

        /* è‡ªåŠ¨å­˜æ¡£ï¼šå†™å…¥èŠ‚æµ */
        let autoWriteTimer = null;
        let lastWriteTs = 0;
        let writing = false;

        function saveDBInternal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            scheduleAutoWrite(); // å¦‚æœå¼€å¯è‡ªåŠ¨åŒæ­¥ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨å†™å…¥å­˜æ¡£æ–‡ä»¶
        }

        function ymd(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }
        function parseYMD(s) {
            const [y, m, d] = s.split("-").map(Number);
            return new Date(y, m - 1, d);
        }
        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

        function timeToMin(t) {
            if (!t) return null;
            const [hh, mm] = t.split(":").map(Number);
            return hh * 60 + mm;
        }
        function minToTime(min) {
            min = ((min % 1440) + 1440) % 1440;
            const hh = String(Math.floor(min / 60)).padStart(2, "0");
            const mm = String(min % 60).padStart(2, "0");
            return `${hh}:${mm}`;
        }
        function fmtMinRange(a, b) { return `${minToTime(a)}â€“${minToTime(b)}`; }
        function minutesBetween(bedMin, wakeMin) {
            if (bedMin == null || wakeMin == null) return null;
            if (wakeMin >= bedMin) return wakeMin - bedMin;
            return (1440 - bedMin) + wakeMin;
        }
        function fmtDuration(mins) {
            if (mins == null) return "â€”";
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h} å°æ—¶ ${m} åˆ†é’Ÿ`;
        }
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, (c) => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
            }[c]));
        }
        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            const rr = Math.min(r, w / 2, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + rr, y);
            ctx.arcTo(x + w, y, x + w, y + h, rr);
            ctx.arcTo(x + w, y + h, x, y + h, rr);
            ctx.arcTo(x, y + h, x, y, rr);
            ctx.arcTo(x, y, x + w, y, rr);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        /* Canvas å­—ä½“ç»Ÿä¸€ï¼ˆä¿®å¤â€œç»Ÿè®¡å›¾å­—ä½“ä¸ä¸€æ ·â€ï¼‰ */
        function setCanvasFont(ctx, sizePx, weight = 400) {
            // ä½¿ç”¨åŒä¸€ä¸ª --font
            const fam = getCSS("--font") || 'system-ui';
            ctx.font = `${weight} ${sizePx}px ${fam}`;
        }

        /* =========================
           ä¸»é¢˜å¼€å…³ï¼ˆæ—¥/å¤œï¼‰
        ========================= */
        const themeToggle = document.getElementById("themeToggle");
        function applyTheme(mode) {
            document.body.classList.toggle("light", mode === "light");
            localStorage.setItem(THEME_KEY, mode);
            themeToggle.textContent = mode === "light" ? "â˜€ï¸ æ—¥é—´" : "ğŸŒ™ å¤œé—´";
        }
        (function initTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            applyTheme(saved === "light" ? "light" : "dark");
        })();
        themeToggle.onclick = () => {
            const isLight = document.body.classList.contains("light");
            applyTheme(isLight ? "dark" : "light");
            redrawAll();
        };



        /* =========================
           å…¨å±€æ—¥æœŸ
        ========================= */
        const today = new Date();
        let selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        let calendarMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

        /* =========================
           UIï¼šæ”¶èµ·æ—¥å†
        ========================= */
        const pageHome = document.getElementById("page-home");
        const calCollapseBtn = document.getElementById("calCollapseBtn");
        const calExpandBtn = document.getElementById("calExpandBtn");
        let uiState = loadUI();

        function applyCalendarCollapsed() {
            const collapsed = !!uiState.calendarCollapsed;
            pageHome.classList.toggle("calendar-collapsed", collapsed);

            // â€œæ”¶èµ·/å±•å¼€â€æŒ‰é’®äº’æ–¥æ˜¾ç¤ºï¼ˆæ”¶èµ·æ—¶ä»ä¿ç•™æ—¥å†æ ‡é¢˜æ ï¼‰
            calCollapseBtn.style.display = collapsed ? "none" : "inline-block";
            calExpandBtn.style.display = collapsed ? "inline-block" : "none";
        }

        function setCalendarCollapsed(collapsed) {
            uiState = { ...uiState, calendarCollapsed: !!collapsed };
            saveUI(uiState);
            applyCalendarCollapsed();
        }

        calCollapseBtn.onclick = () => setCalendarCollapsed(true);
        calExpandBtn.onclick = () => setCalendarCollapsed(false);

        applyCalendarCollapsed();

        /* =========================
           Task Typesï¼ˆä»»åŠ¡ç±»å‹ï¼‰
        ========================= */
        function getType(id) {
            return db.taskTypes.list.find(t => t.id === id) || db.taskTypes.list.find(t => t.id === "uncat");
        }
        function getTypeColor(id) {
            const t = getType(id);
            return (t && t.color) ? t.color : (getCSS("--accent") || "#7aa2ff");
        }
        function renderTypeOptions(selectEl, selectedId) {
            const opts = db.taskTypes.list.map(t => {
                const sel = (t.id === selectedId) ? "selected" : "";
                return `<option value="${t.id}" ${sel}>${escapeHtml(t.name)}</option>`;
            }).join("");
            selectEl.innerHTML = opts;
        }

        /* =========================
           Days æ•°æ®
        ========================= */
        function dayData(dateKey) {
            db.days[dateKey] ||= { activities: [], pomodoro: { morning: 0, noon: 0, evening: 0 }, sleep: { wake: "", bed: "" } };
            db.days[dateKey].activities ||= [];
            db.days[dateKey].pomodoro ||= { morning: 0, noon: 0, evening: 0 };
            db.days[dateKey].sleep ||= { wake: "", bed: "" };
            return db.days[dateKey];
        }
        function normalizeSegment(seg) {
            let s = clamp(seg.startMin, 0, 1440);
            let e = clamp(seg.endMin, 0, 1440);
            if (e <= s) e = clamp(s + 5, 0, 1440);
            return { ...seg, startMin: s, endMin: e, typeId: seg.typeId || "uncat" };
        }
        function sortActs(acts) {
            return acts.map(normalizeSegment).sort((a, b) => a.startMin - b.startMin);
        }
        function getActivities(dateKey) { return sortActs(dayData(dateKey).activities); }
        function setActivities(dateKey, list) {
            dayData(dateKey).activities = sortActs(list);
            saveDBInternal();
        }

        /* =========================
           é¡µé¢åˆ‡æ¢
        ========================= */
        const tabs = document.querySelectorAll(".tab[data-page]");
        const pages = {
            home: document.getElementById("page-home"),
            habits: document.getElementById("page-habits"),
            pomodoro: document.getElementById("page-pomodoro"),
            sleep: document.getElementById("page-sleep"),
            stats: document.getElementById("page-stats"),
        };
        function showPage(name) {
            for (const t of tabs) t.classList.toggle("active", t.dataset.page === name);
            for (const [k, el] of Object.entries(pages)) el.style.display = (k === name) ? "" : "none";
            redrawAll(name);
        }
        tabs.forEach(t => t.addEventListener("click", () => showPage(t.dataset.page)));

        /* =========================
           ä¸»é¡µé¢ï¼šç¯å½¢æ—¶é—´è½´
        ========================= */
        const ring = document.getElementById("ring");
        const rctx = ring.getContext("2d");
        const timelineEl = document.getElementById("timeline");
        const daySummaryEl = document.getElementById("daySummary");
        const selDateLabel = document.getElementById("selDateLabel");
        const subtitle = document.getElementById("subtitle");

        function ringGeom() {
            const w = ring.width, h = ring.height;
            const cx = w / 2, cy = h / 2;
            const outer = Math.min(w, h) * 0.45;
            const inner = outer * 0.72;
            return { w, h, cx, cy, outer, inner };
        }
        function angleToMin(angle) {
            let a = angle - (-Math.PI / 2);
            while (a < 0) a += Math.PI * 2;
            while (a >= Math.PI * 2) a -= Math.PI * 2;
            return Math.round((a / (Math.PI * 2)) * 1440);
        }
        function minToAngle(min) {
            const ratio = min / 1440;
            return (-Math.PI / 2) + ratio * Math.PI * 2;
        }

        function drawRing(preview = null) {
            const { w, h, cx, cy, outer, inner } = ringGeom();
            rctx.clearRect(0, 0, w, h);

            // èƒŒæ™¯ç›˜
            rctx.beginPath();
            rctx.arc(cx, cy, outer, 0, Math.PI * 2);
            rctx.arc(cx, cy, inner, 0, Math.PI * 2, true);
            rctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            rctx.fill("evenodd");

            // åˆ»åº¦
            for (let hr = 0; hr < 24; hr++) {
                const m = hr * 60;
                const a = minToAngle(m);
                const x1 = cx + Math.cos(a) * (inner - 6);
                const y1 = cy + Math.sin(a) * (inner - 6);
                const x2 = cx + Math.cos(a) * (outer + 2);
                const y2 = cy + Math.sin(a) * (outer + 2);
                const strong = (hr % 6 === 0);
                rctx.strokeStyle = strong
                    ? (document.body.classList.contains("light") ? "rgba(10,20,40,.22)" : "rgba(255,255,255,.26)")
                    : (document.body.classList.contains("light") ? "rgba(10,20,40,.12)" : "rgba(255,255,255,.12)");
                rctx.lineWidth = strong ? 2 : 1;
                rctx.beginPath(); rctx.moveTo(x1, y1); rctx.lineTo(x2, y2); rctx.stroke();

                if (hr % 3 === 0) {
                    const tx = cx + Math.cos(a) * (inner - 26);
                    const ty = cy + Math.sin(a) * (inner - 26);
                    rctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.80)" : "rgba(233,238,252,.78)";
                    setCanvasFont(rctx, 12, 500);
                    rctx.textAlign = "center";
                    rctx.textBaseline = "middle";
                    rctx.fillText(String(hr), tx, ty);
                }
            }

            // æ´»åŠ¨æ®µï¼šé¢œè‰²æ¥è‡ªä»»åŠ¡ç±»å‹
            const dateKey = ymd(selectedDate);
            const acts = getActivities(dateKey);
            for (const seg of acts) {
                const a1 = minToAngle(seg.startMin);
                const a2 = minToAngle(seg.endMin);
                rctx.beginPath();
                rctx.arc(cx, cy, outer, a1, a2);
                rctx.arc(cx, cy, inner, a2, a1, true);
                rctx.closePath();
                rctx.fillStyle = getTypeColor(seg.typeId);
                rctx.globalAlpha = 0.86;
                rctx.fill();
                rctx.globalAlpha = 1;
            }

            // é¢„è§ˆæ®µ
            if (preview) {
                const p = normalizeSegment(preview);
                const a1 = minToAngle(p.startMin);
                const a2 = minToAngle(p.endMin);
                rctx.beginPath();
                rctx.arc(cx, cy, outer, a1, a2);
                rctx.arc(cx, cy, inner, a2, a1, true);
                rctx.closePath();
                rctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.10)" : "rgba(255,255,255,.16)";
                rctx.fill();
            }

            // å½“å‰æ—¶é—´æŒ‡é’ˆ
            if (ymd(selectedDate) === ymd(today)) {
                const now = new Date();
                const nowMin = now.getHours() * 60 + now.getMinutes();
                const a = minToAngle(nowMin);
                const x1 = cx + Math.cos(a) * (inner - 2);
                const y1 = cy + Math.sin(a) * (inner - 2);
                const x2 = cx + Math.cos(a) * (outer + 10);
                const y2 = cy + Math.sin(a) * (outer + 10);
                rctx.strokeStyle = "rgba(70,211,154,.9)";
                rctx.lineWidth = 3;
                rctx.beginPath(); rctx.moveTo(x1, y1); rctx.lineTo(x2, y2); rctx.stroke();
                rctx.fillStyle = "rgba(70,211,154,.95)";
                rctx.beginPath(); rctx.arc(x2, y2, 4, 0, Math.PI * 2); rctx.fill();
            }

            // ä¸­å¿ƒæ–‡æœ¬
            // ä¸­å¿ƒæ–‡æœ¬ï¼šæ—¥æœŸï¼ˆyyyyå¹´mmæœˆddæ—¥ï¼‰
            const dateObj = selectedDate;
            const dateStr = `${dateObj.getFullYear()}å¹´${String(dateObj.getMonth() + 1).padStart(2, "0")}æœˆ${String(dateObj.getDate()).padStart(2, "0")}æ—¥`;
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}:${String(now.getSeconds()).padStart(2, "0")}`;
            rctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.92)" : "rgba(233,238,252,.92)";
            setCanvasFont(rctx, 22, 700);
            rctx.textAlign = "center";
            rctx.textBaseline = "middle";
            rctx.fillText(dateStr, cx, cy - 16);
            setCanvasFont(rctx, 18, 700);
            rctx.fillText(timeStr, cx, cy + 16);

            const actCount = getActivities(ymd(selectedDate)).length;
            rctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
            setCanvasFont(rctx, 16, 500);
            rctx.fillText(`ä»Šæ—¥å·²è®°å½• ${actCount} æ¡`, cx, cy + 48);
        }

        /* ç¯å½¢äº¤äº’ */
        let dragging = false;
        let dragStartMin = null;
        let dragCurMin = null;

        function pointToAngle(ev) {
            const rect = ring.getBoundingClientRect();
            const x = (ev.clientX - rect.left) * (ring.width / rect.width);
            const y = (ev.clientY - rect.top) * (ring.height / rect.height);
            const { cx, cy, outer, inner } = ringGeom();
            const dx = x - cx, dy = y - cy;
            const dist = Math.hypot(dx, dy);
            if (dist < inner - 10 || dist > outer + 18) return null;
            return Math.atan2(dy, dx);
        }
        ring.addEventListener("mousedown", (ev) => {
            const ang = pointToAngle(ev);
            if (ang == null) return;
            dragging = true;
            dragStartMin = angleToMin(ang);
            dragCurMin = dragStartMin;
            drawRing({ startMin: Math.min(dragStartMin, dragCurMin), endMin: Math.max(dragStartMin, dragCurMin), typeId: "uncat" });
        });
        window.addEventListener("mousemove", (ev) => {
            if (!dragging) return;
            const ang = pointToAngle(ev);
            if (ang == null) return;
            dragCurMin = angleToMin(ang);
            drawRing({ startMin: Math.min(dragStartMin, dragCurMin), endMin: Math.max(dragStartMin, dragCurMin), typeId: "uncat" });
        });
        window.addEventListener("mouseup", () => {
            if (!dragging) return;
            dragging = false;
            let s = Math.min(dragStartMin, dragCurMin);
            let e = Math.max(dragStartMin, dragCurMin);
            if (Math.abs(e - s) < 5) {
                s = dragStartMin;
                e = clamp(s + 30, 0, 1440);
            }
            openActivityModal({ startMin: s, endMin: e, label: "", typeId: "uncat" }, null);
        });

        // æ”¯æŒç§»åŠ¨ç«¯è§¦æ‘¸æ‹–åŠ¨
        function getTouchPoint(ev) {
            // åªå–ç¬¬ä¸€ä¸ªè§¦ç‚¹
            const t = ev.touches[0] || ev.changedTouches[0];
            return {
                clientX: t.clientX,
                clientY: t.clientY
            };
        }

        ring.addEventListener("touchstart", (ev) => {
            if (ev.touches.length > 1) return; // å¿½ç•¥å¤šæŒ‡
            const { clientX, clientY } = getTouchPoint(ev);
            const fakeEv = { clientX, clientY };
            const ang = pointToAngle(fakeEv);
            if (ang == null) return;
            dragging = true;
            dragStartMin = angleToMin(ang);
            dragCurMin = dragStartMin;
            drawRing({ startMin: Math.min(dragStartMin, dragCurMin), endMin: Math.max(dragStartMin, dragCurMin), typeId: "uncat" });
            ev.preventDefault();
        }, { passive: false });

        ring.addEventListener("touchmove", (ev) => {
            if (!dragging) return;
            const { clientX, clientY } = getTouchPoint(ev);
            const fakeEv = { clientX, clientY };
            const ang = pointToAngle(fakeEv);
            if (ang == null) return;
            dragCurMin = angleToMin(ang);
            drawRing({ startMin: Math.min(dragStartMin, dragCurMin), endMin: Math.max(dragStartMin, dragCurMin), typeId: "uncat" });
            ev.preventDefault();
        }, { passive: false });

        ring.addEventListener("touchend", (ev) => {
            if (!dragging) return;
            dragging = false;
            let s = Math.min(dragStartMin, dragCurMin);
            let e = Math.max(dragStartMin, dragCurMin);
            if (Math.abs(e - s) < 5) {
                s = dragStartMin;
                e = clamp(s + 30, 0, 1440);
            }
            openActivityModal({ startMin: s, endMin: e, label: "", typeId: "uncat" }, null);
            ev.preventDefault();
        }, { passive: false });

        /* =========================
           æ´»åŠ¨å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘/åˆ é™¤ + ç±»å‹
        ========================= */
        const mask = document.getElementById("mask");
        const modalClose = document.getElementById("modalClose");
        const modalCancel = document.getElementById("modalCancel");
        const modalSave = document.getElementById("modalSave");
        const modalDelete = document.getElementById("modalDelete");
        const actStart = document.getElementById("actStart");
        const actEnd = document.getElementById("actEnd");
        const actLabel = document.getElementById("actLabel");
        const actType = document.getElementById("actType");
        const actTypeSw = document.getElementById("actTypeSw");
        const actTypeName = document.getElementById("actTypeName");

        let editingIndex = null;

        function syncTypeBadge() {
            const t = getType(actType.value);
            actTypeSw.style.background = t.color;
            actTypeName.textContent = t.name;
        }
        function openActivityModal(seg, index) {
            editingIndex = index;
            actStart.value = minToTime(seg.startMin);
            actEnd.value = minToTime(seg.endMin);
            actLabel.value = seg.label || "";
            renderTypeOptions(actType, seg.typeId || "uncat");
            syncTypeBadge();
            modalDelete.style.display = (index == null) ? "none" : "";
            mask.classList.add("show");
            actLabel.focus();
        }
        function closeActivityModal() {
            mask.classList.remove("show");
            editingIndex = null;
        }
        modalClose.onclick = closeActivityModal;
        modalCancel.onclick = closeActivityModal;
        mask.addEventListener("click", (e) => { if (e.target === mask) closeActivityModal(); });
        actType.addEventListener("change", syncTypeBadge);

        modalSave.onclick = () => {
            const s = timeToMin(actStart.value);
            const e = timeToMin(actEnd.value);
            const label = (actLabel.value || "").trim();
            const typeId = actType.value || "uncat";

            if (s == null || e == null) { alert("è¯·å¡«å†™å¼€å§‹ä¸ç»“æŸæ—¶é—´"); return; }
            if (e <= s) { alert("ç»“æŸæ—¶é—´éœ€è¦æ™šäºå¼€å§‹æ—¶é—´ï¼ˆä¸è·¨å¤©ï¼‰ã€‚å¦‚éœ€è·¨å¤©ï¼Œè¯·æ‹†æˆä¸¤æ®µè®°å½•ã€‚"); return; }
            if (!label) { alert("è¯·å¡«å†™æ´»åŠ¨åç§°"); return; }

            const dateKey = ymd(selectedDate);
            const acts = getActivities(dateKey);
            const seg = { startMin: s, endMin: e, label, typeId };

            if (editingIndex == null) acts.push(seg);
            else acts[editingIndex] = seg;

            setActivities(dateKey, acts);
            closeActivityModal();
            renderAllHome();
            renderStats();
        };
        modalDelete.onclick = () => {
            if (editingIndex == null) return;
            const dateKey = ymd(selectedDate);
            const acts = getActivities(dateKey);
            acts.splice(editingIndex, 1);
            setActivities(dateKey, acts);
            closeActivityModal();
            renderAllHome();
            renderStats();
        };

        /* =========================
           æ—¶é—´è½´åˆ—è¡¨
        ========================= */
        function renderTimeline() {
            const dateKey = ymd(selectedDate);
            const acts = getActivities(dateKey);
            timelineEl.innerHTML = "";

            if (acts.length === 0) {
                timelineEl.innerHTML = `<div class="muted">æš‚æ— è®°å½•ã€‚å¯ä»¥åœ¨å·¦ä¾§ç¯ä¸Šç‚¹å‡»/æ‹–åŠ¨æ–°å¢ã€‚</div>`;
                daySummaryEl.textContent = "â€”";
                return;
            }

            let totalMin = 0;
            acts.forEach((seg, idx) => {
                const dur = seg.endMin - seg.startMin;
                totalMin += dur;

                const t = getType(seg.typeId);
                const color = t.color;

                const el = document.createElement("div");
                el.className = "entry";
                el.innerHTML = `
      <div class="bar" style="background:${color}"></div>
      <div class="ct">
        <div class="t">
          <b>${escapeHtml(seg.label)}</b>
          <span>${fmtMinRange(seg.startMin, seg.endMin)}</span>
        </div>
        <div class="meta">
          <span>ç±»å‹ï¼š${escapeHtml(t.name)}</span>
          <span>æ—¶é•¿ï¼š${fmtDuration(dur)}</span>
        </div>
      </div>
    `;
                el.addEventListener("click", () => openActivityModal(seg, idx));
                timelineEl.appendChild(el);
            });

            daySummaryEl.textContent = `æ€»è®°å½•æ—¶é•¿ï¼š${fmtDuration(totalMin)}`;
        }

        /* =========================
           æ—¥å†
        ========================= */
        const calDow = document.getElementById("calDow");
        const calGrid = document.getElementById("calGrid");
        const calTitle = document.getElementById("calTitle");

        document.getElementById("calPrev").onclick = () => {
            calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1);
            renderCalendar();
        };
        document.getElementById("calNext").onclick = () => {
            calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1);
            renderCalendar();
        };

        function renderCalendar() {
            const dows = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"];
            calDow.innerHTML = dows.map(x => `<div class="dow">å‘¨${x}</div>`).join("");

            const y = calendarMonth.getFullYear();
            const m = calendarMonth.getMonth();
            calTitle.textContent = `${y} å¹´ ${String(m + 1).padStart(2, "0")} æœˆ`;

            const first = new Date(y, m, 1);
            const firstDow = (first.getDay() + 6) % 7;
            const start = new Date(y, m, 1 - firstDow);

            const cells = [];
            for (let i = 0; i < 42; i++) {
                const cur = new Date(start.getFullYear(), start.getMonth(), start.getDate() + i);
                const curKey = ymd(cur);
                const inMonth = (cur.getMonth() === m);
                const isSel = (curKey === ymd(selectedDate));
                const isToday = (curKey === ymd(today));

                const acts = getActivities(curKey);
                const chips = acts.slice(0, 6).map(a => {
                    const c = getTypeColor(a.typeId);
                    return `<span class="chip" style="background:${c}"></span>`;
                }).join("");

                cells.push(`
      <div class="day ${inMonth ? "" : "off"} ${isSel ? "sel" : ""} ${isToday ? "today" : ""}" data-date="${curKey}">
        <div class="n">${cur.getDate()}</div>
        <div class="chips">${chips}</div>
      </div>
    `);
            }
            calGrid.innerHTML = cells.join("");

            calGrid.querySelectorAll(".day").forEach(el => {
                el.addEventListener("click", () => {
                    selectedDate = parseYMD(el.dataset.date);
                    calendarMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                    renderAllHome();
                    renderStatsDayLabel();
                    renderStats();
                });
            });

            selDateLabel.textContent = `å·²é€‰ï¼š${ymd(selectedDate)}`;
        }

        /* ä¸»é¡µé¢æŒ‰é’® */
        document.getElementById("btnToday").onclick = () => {
            selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            calendarMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            renderAllHome();
            renderStatsDayLabel();
            renderStats();
        };
        document.getElementById("btnClearDay").onclick = () => {
            const key = ymd(selectedDate);
            if (!confirm(`ç¡®å®šæ¸…ç©º ${key} çš„æ´»åŠ¨è®°å½•å—ï¼Ÿ`)) return;
            dayData(key).activities = [];
            saveDBInternal();
            renderAllHome();
            renderStats();
        };

        function renderAllHome() {
            selDateLabel.textContent = `å·²é€‰ï¼š${ymd(selectedDate)}`;
            // subtitleæ ¹æ®æ—¥æœŸä¸‰æ€æ˜¾ç¤º
            const selYMD = ymd(selectedDate);
            const todayYMD = ymd(today);
            if (selYMD === todayYMD) {
                subtitle.textContent = `ä»Šæ—¥ï¼š${selYMD}`;
            } else {
                const selDateObj = parseYMD(selYMD);
                if (selDateObj < today) {
                    subtitle.textContent = `å†å²ï¼š${selYMD}`;
                } else {
                    subtitle.textContent = `æœªæ¥ï¼š${selYMD}`;
                }
            }

            // logoä¸‰æ€+æ—¥æœŸ
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.classList.remove('red', 'today', 'future');
                const selYMD = ymd(selectedDate);
                const todayYMD = ymd(today);
                if (selYMD === todayYMD) {
                    logo.classList.add('today');
                } else {
                    const selDateObj = parseYMD(selYMD);
                    if (selDateObj < today) {
                        logo.classList.add('red');
                    } else {
                        logo.classList.add('future');
                    }
                }
                // æ˜¾ç¤ºâ€œxæ—¥â€
                const dayNum = selectedDate.getDate();
                logo.textContent = `${dayNum}å·`;
            }

            renderCalendar();
            drawRing();
            renderTimeline();
        }

        /* =========================
           ä¹ æƒ¯ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
        ========================= */
        const habitMask = document.getElementById("habitMask");
        const btnAddHabit = document.getElementById("btnAddHabit");
        const habitClose = document.getElementById("habitClose");
        const habitCancel = document.getElementById("habitCancel");
        const habitCreate = document.getElementById("habitCreate");
        const habitName = document.getElementById("habitName");
        const habitStartDate = document.getElementById("habitStartDate");
        const habitListEl = document.getElementById("habitList");
        const habitTitle = document.getElementById("habitTitle");
        const habitBody = document.getElementById("habitBody");
        const habitKpi = document.getElementById("habitKpi");
        const kpiCycle = document.getElementById("kpiCycle");
        const kpiAll = document.getElementById("kpiAll");
        const kpiStreak = document.getElementById("kpiStreak");
        const btnDeleteHabit = document.getElementById("btnDeleteHabit");
        const cyclePrev = document.getElementById("cyclePrev");
        const cycleNext = document.getElementById("cycleNext");
        const habitChart = document.getElementById("habitChart");
        const hctx = habitChart.getContext("2d");

        let selectedHabitId = null;
        let cycleOffset = 0;

        function openHabitModal() {
            habitName.value = "";
            habitStartDate.value = ymd(today);
            habitMask.classList.add("show");
            habitName.focus();
        }
        function closeHabitModal() { habitMask.classList.remove("show"); }
        btnAddHabit.onclick = openHabitModal;
        habitClose.onclick = closeHabitModal;
        habitCancel.onclick = closeHabitModal;
        habitMask.addEventListener("click", (e) => { if (e.target === habitMask) closeHabitModal(); });

        habitCreate.onclick = () => {
            const name = (habitName.value || "").trim();
            const start = habitStartDate.value;
            if (!name) { alert("è¯·å¡«å†™ä¹ æƒ¯åç§°"); return; }
            if (!start) { alert("è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ"); return; }
            const id = "h_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
            db.habits.list.push({ id, name, cycleStart: start, created: ymd(today) });
            db.habits.records[id] ||= {};
            saveDBInternal();
            closeHabitModal();
            selectedHabitId = id;
            cycleOffset = 0;
            renderHabits();
        };

        function getHabit(id) { return db.habits.list.find(h => h.id === id) || null; }
        function getCycleStartForDate(habit, dateObj) {
            const base = parseYMD(habit.cycleStart);
            const d0 = new Date(base.getFullYear(), base.getMonth(), base.getDate());
            const d1 = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
            const diffDays = Math.floor((d1 - d0) / 86400000);
            const k = Math.floor(diffDays / 10);
            const cycleStartDate = new Date(d0.getFullYear(), d0.getMonth(), d0.getDate() + k * 10);
            return ymd(cycleStartDate);
        }
        function getCycleKey(habit) {
            const baseCycle = getCycleStartForDate(habit, today);
            const base = parseYMD(baseCycle);
            const cur = new Date(base.getFullYear(), base.getMonth(), base.getDate() + cycleOffset * 10);
            return ymd(cur);
        }
        function ensureCycleRecord(habitId, cycleKey) {
            db.habits.records[habitId] ||= {};
            db.habits.records[habitId][cycleKey] ||= Array.from({ length: 10 }, () => false);
            return db.habits.records[habitId][cycleKey];
        }
        function drawSimpleMessage(ctx, canvas, msg) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
            setCanvasFont(ctx, 12, 500);
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(msg, canvas.width / 2, canvas.height / 2);
            ctx.textAlign = "start";
            ctx.textBaseline = "alphabetic";
        }
        function calcHabitStreak(habit) {
            let streak = 0;
            for (let back = 0; back < 60; back++) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - back);
                const cycleKey = getCycleStartForDate(habit, d);
                const cur = parseYMD(cycleKey);
                const idx = Math.floor((d - cur) / 86400000);
                const rec = ensureCycleRecord(habit.id, cycleKey);
                const ok = (idx >= 0 && idx < 10) ? !!rec[idx] : false;
                if (ok) streak++;
                else break;
            }
            return String(streak);
        }
        function drawHabitLast30(habit) {
            const ctx = hctx;
            const canvas = habitChart;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ›´ç°ä»£çš„è¾¹è·å’Œåœ†è§’
            const padL = 40, padR = 20, padT = 24, padB = 32;
            const W = canvas.width - padL - padR;
            const H = canvas.height - padT - padB;

            // èƒŒæ™¯æ¸å˜
            const bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGrad.addColorStop(0, document.body.classList.contains("light") ? "#e3f0ff" : "#232a3a");
            bgGrad.addColorStop(1, document.body.classList.contains("light") ? "#f7fbff" : "#181c2b");
            ctx.fillStyle = bgGrad;
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 18, true, false);

            const days = [];
            for (let i = 9; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const cycleKey = getCycleStartForDate(habit, d);
                const curCycleStart = parseYMD(cycleKey);
                const idx = Math.floor((d - curCycleStart) / 86400000);
                const rec = ensureCycleRecord(habit.id, cycleKey);
                const done = (idx >= 0 && idx < 10) ? !!rec[idx] : false;
                days.push({ key: ymd(d), done });
            }

            const barW = W / days.length;
            ctx.strokeStyle = document.body.classList.contains("light") ? "#b3d1ff" : "#2c3550";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padL, padT + H);
            ctx.lineTo(padL + W, padT + H);
            ctx.stroke();

            // è“è‰²æ¸å˜æŸ±çŠ¶å›¾
            for (let i = 0; i < days.length; i++) {
                const x = padL + i * barW + 2;
                const h = days[i].done ? H * 0.75 : H * 0.2;
                let grad = ctx.createLinearGradient(x, padT + (H - h), x, padT + H);
                if (days[i].done) {
                    grad.addColorStop(0, "#2563eb");
                    grad.addColorStop(1, "#60a5fa");
                } else {
                    grad.addColorStop(0, document.body.classList.contains("light") ? "#dbeafe" : "#232a3a");
                    grad.addColorStop(1, document.body.classList.contains("light") ? "#e0e7ef" : "#181c2b");
                }
                ctx.fillStyle = grad;
                ctx.shadowColor = days[i].done ? "#60a5fa" : "transparent";
                ctx.shadowBlur = days[i].done ? 8 : 0;
                ctx.fillRect(x, padT + (H - h), Math.max(6, barW - 8), h);
                ctx.shadowBlur = 0;
            }

            // æ—¥æœŸæ ‡ç­¾ç¾åŒ–
            ctx.fillStyle = document.body.classList.contains("light") ? "#3b82f6" : "#7aa2ff";
            setCanvasFont(ctx, 13, 600);
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(days[0].key, padL, canvas.height - 12);
            ctx.fillText(days[days.length - 1].key, padL + W - 20, canvas.height - 12);


        }
        function renderHabits() {
            habitListEl.innerHTML = "";
            if (db.habits.list.length === 0) {
                habitListEl.innerHTML = `<div class="muted">æš‚æ— ä¹ æƒ¯ã€‚ç‚¹å‡»â€œæ–°å¢ä¹ æƒ¯â€å¼€å§‹ã€‚</div>`;
            } else {
                db.habits.list.forEach((h, idx) => {
                    const el = document.createElement("div");
                    el.className = "habit-item" + (h.id === selectedHabitId ? " sel" : "");
                    el.innerHTML = `
        <div>
          <div class="habit-name">${escapeHtml(h.name)}</div>
          <div class="habit-sub">èµ·å§‹ï¼š${h.cycleStart} Â· 10 å¤©å¾ªç¯</div>
        </div>
        <div class="chip" style="width:14px;height:14px;background:${["#7aa2ff", "#46d39a", "#ffcc66", "#ff6b6b", "#a78bfa"][idx % 5]}"></div>
      `;
                    el.onclick = () => {
                        selectedHabitId = h.id;
                        cycleOffset = 0;
                        renderHabits();
                    };
                    habitListEl.appendChild(el);
                });
            }

            const habit = selectedHabitId ? getHabit(selectedHabitId) : null;
            if (!habit) {
                habitTitle.textContent = "è¯·é€‰æ‹©ä¸€ä¸ªä¹ æƒ¯";
                habitBody.className = "muted";
                habitBody.textContent = "é€‰æ‹©ä¸€ä¸ªä¹ æƒ¯åï¼Œè¿™é‡Œä¼šå‡ºç° 10 ä¸ªæ–¹æ¡†ä¾›ä½ æ‰“é’©ã€‚";
                habitKpi.style.display = "none";
                btnDeleteHabit.style.display = "none";
                drawSimpleMessage(hctx, habitChart, "è¯·é€‰æ‹©ä¸€ä¸ªä¹ æƒ¯ä»¥æ˜¾ç¤ºç»Ÿè®¡å›¾");
                return;
            }

            btnDeleteHabit.style.display = "";
            btnDeleteHabit.onclick = () => {
                if (!confirm(`ç¡®å®šåˆ é™¤ä¹ æƒ¯ã€Œ${habit.name}ã€åŠå…¶å…¨éƒ¨è®°å½•å—ï¼Ÿ`)) return;
                db.habits.list = db.habits.list.filter(x => x.id !== habit.id);
                delete db.habits.records[habit.id];
                saveDBInternal();
                selectedHabitId = db.habits.list[0]?.id || null;
                cycleOffset = 0;
                renderHabits();
            };

            cyclePrev.onclick = () => { cycleOffset -= 1; renderHabits(); };
            cycleNext.onclick = () => { cycleOffset += 1; renderHabits(); };

            const cycleKey = getCycleKey(habit);
            const record = ensureCycleRecord(habit.id, cycleKey);

            habitTitle.textContent = `${habit.name}ï¼ˆå¾ªç¯èµ·å§‹ï¼š${cycleKey}ï¼‰`;

            const startDate = parseYMD(cycleKey);
            const boxes = [];
            for (let i = 0; i < 10; i++) {
                const day = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i);
                const dayKey = ymd(day);
                const on = !!record[i];
                boxes.push(`<div class="box ${on ? "on" : ""}" data-i="${i}" title="${dayKey}">${i + 1}</div>`);
            }

            habitBody.className = "";
            habitBody.innerHTML = `
    <div class="muted">ç‚¹å‡»æ–¹æ¡†æ‰“é’©/å–æ¶ˆï¼ˆæ¯ä¸ªæ–¹æ¡†ä»£è¡¨å¾ªç¯ä¸­çš„ä¸€å¤©ï¼‰ã€‚æ‚¬åœå¯çœ‹æ—¥æœŸã€‚</div>
    <div class="ten-grid" id="tenGrid">${boxes.join("")}</div>
  `;
            habitBody.querySelectorAll(".box").forEach(el => {
                el.onclick = () => {
                    const i = Number(el.dataset.i);
                    record[i] = !record[i];
                    saveDBInternal();
                    renderHabits();
                };
            });

            habitKpi.style.display = "";
            const doneCycle = record.filter(Boolean).length;
            kpiCycle.textContent = `${doneCycle} / 10`;

            const all = db.habits.records[habit.id] || {};
            let totalSlots = 0, totalDone = 0;
            Object.values(all).forEach(arr => {
                totalSlots += arr.length;
                totalDone += arr.filter(Boolean).length;
            });
            const rate = totalSlots ? Math.round((totalDone / totalSlots) * 100) : 0;
            kpiAll.textContent = `${rate}%`;
            kpiStreak.textContent = calcHabitStreak(habit);

            drawHabitLast30(habit);
        }

        /* =========================
           ç•ªèŒ„é’Ÿ
        ========================= */
        const pomDateLabel = document.getElementById("pomDateLabel");
        const pomTotalHint = document.getElementById("pomTotalHint");
        const pomChart = document.getElementById("pomChart");
        const pctx = pomChart.getContext("2d");

        document.getElementById("pomPrevDay").onclick = () => { selectedDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() - 1); renderPomodoro(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("pomNextDay").onclick = () => { selectedDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() + 1); renderPomodoro(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("pomToday").onclick = () => { selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()); renderPomodoro(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("pomClear").onclick = () => {
            const key = ymd(selectedDate);
            if (!confirm(`ç¡®å®šæ¸…ç©º ${key} çš„ç•ªèŒ„é’Ÿè®°å½•å—ï¼Ÿ`)) return;
            dayData(key).pomodoro = { morning: 0, noon: 0, evening: 0 };
            saveDBInternal();
            renderPomodoro();
        };

        document.querySelectorAll("[data-pom]").forEach(btn => {
            btn.addEventListener("click", () => {
                const part = btn.dataset.pom;
                const delta = Number(btn.dataset.delta);
                const key = ymd(selectedDate);
                const pom = dayData(key).pomodoro;
                pom[part] = clamp((pom[part] || 0) + delta, 0, 30);
                saveDBInternal();
                renderPomodoro();
            });
        });
        function tomatoes(n) {
            // æœ€å¤š8ä¸ªç•ªèŒ„ï¼Œæœªå®Œæˆæ˜¾ç¤ºç°è‰²ç•ªèŒ„ï¼Œå¯ç‚¹å‡»æ·»åŠ 
            let html = '';
            for (let i = 0; i < 8; i++) {
                if (i < n) {
                    html += `<span class="tomato tomato-done" style="font-size:28px;cursor:default;">ğŸ…</span>`;
                } else {
                    html += `<span class="tomato tomato-empty" style="font-size:28px;filter:grayscale(100%);opacity:.0.3;cursor:pointer;transition: all 0.3s ease;"${i}">ğŸ…</span>`;
                }
            }
            return html;
        }
        function drawPomChart(arr) {
            const ctx = pctx, canvas = pomChart;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

            const padL = 48, padR = 12, padT = 24, padB = 38;
            const W = canvas.width - padL - padR;
            const H = canvas.height - padT - padB;
            // è®¡ç®—æœ€å¤§ä¸“æ³¨å°æ—¶æ•°
            const maxHour = Math.max(2, ...arr.map(x => x.hourTotal));
            const barW = W / arr.length;

            // ç”»æ¨ªè½´
            ctx.strokeStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.10)" : "rgba(255,255,255,.10)";
            ctx.beginPath();
            ctx.moveTo(padL, padT + H);
            ctx.lineTo(padL + W, padT + H);
            ctx.stroke();

            // ç”»çºµè½´åˆ»åº¦ï¼ˆ0, 1, 2, ...maxHourï¼‰
            ctx.font = "13px sans-serif";
            ctx.fillStyle = "#888";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            const yStep = Math.ceil(maxHour);
            for (let i = 0; i <= yStep; i++) {
                const y = padT + H - (H * (i / yStep));
                ctx.fillText(i, padL - 8, y);
                // æ¨ªçº¿
                ctx.strokeStyle = "#f0f0f0";
                ctx.beginPath();
                ctx.moveTo(padL, y);
                ctx.lineTo(padL + W, y);
                ctx.stroke();
            }

            // é¢œè‰²
            const colors = {
                morning: "#E06C6C",
                noon: "#ffb347",
                evening: "#7aa2ff"
            };

            // å †ç§¯æŸ±çŠ¶å›¾
            for (let i = 0; i < arr.length; i++) {
                const x = padL + i * barW + 4;
                let y = padT + H;
                // æ—©æ™¨
                const hMorning = (arr[i].morningHour / maxHour) * H;
                ctx.fillStyle = colors.morning;
                ctx.fillRect(x, y - hMorning, Math.max(8, barW - 8), hMorning);
                y -= hMorning;
                // ä¸­åˆ
                const hNoon = (arr[i].noonHour / maxHour) * H;
                ctx.fillStyle = colors.noon;
                ctx.fillRect(x, y - hNoon, Math.max(8, barW - 8), hNoon);
                y -= hNoon;
                // æ™šä¸Š
                const hEvening = (arr[i].eveningHour / maxHour) * H;
                ctx.fillStyle = colors.evening;
                ctx.fillRect(x, y - hEvening, Math.max(8, barW - 8), hEvening);
            }

            // æ—¥æœŸæ ‡ç­¾
            ctx.save();
            ctx.font = "12px sans-serif";
            ctx.fillStyle = "#888";
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            for (let i = 0; i < arr.length; i++) {
                const x = padL + i * barW + barW / 2;
                const label = arr[i].k.slice(5); // MM-DD
                ctx.fillText(label, x, padT + H + 6);
            }
            ctx.restore();

            // å›¾ä¾‹
            const legend = [
                { color: colors.morning, label: "æ—©æ™¨" },
                { color: colors.noon, label: "ä¸­åˆ" },
                { color: colors.evening, label: "æ™šä¸Š" }
            ];
            legend.forEach((item, idx) => {
                ctx.fillStyle = item.color;
                ctx.fillRect(padL + 320 + idx * 70, padT - 18, 16, 12);
                ctx.font = "13px sans-serif";
                ctx.fillStyle = "#444";
                ctx.textAlign = "left";
                ctx.textBaseline = "middle";
                ctx.fillText(item.label, padL + 340 + idx * 70, padT - 12);
            });

            // æ ‡é¢˜
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.85)" : "rgba(233,238,252,.85)";
            setCanvasFont(ctx, 13, 600);
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
        }

        function renderPomodoro() {
            const key = ymd(selectedDate);
            const pom = dayData(key).pomodoro;
            const pomSummaryTotal = (pom.morning || 0) + (pom.noon || 0) + (pom.evening || 0);
            // ä¸“æ³¨å°æ—¶ï¼šä»¥å°æ—¶ä¸ºå•ä½ï¼Œä¿ç•™ä¸€ä½å°æ•°
            const pomSummaryHour = ((pomSummaryTotal * 25) / 60).toFixed(1);
            // æ•ˆç‡åˆ†æ•°ï¼šç™¾åˆ†æ¯”
            const pomSummaryScore = Math.round((pomSummaryTotal / 24) * 100) + "%";

            // æœ€ä½³æ—¶æ®µ
            const bestArr = [
                { label: "æ—©æ™¨", value: pom.morning || 0, color: "#E06C6C" },
                { label: "ä¸­åˆ", value: pom.noon || 0, color: "#FFB347" },
                { label: "æ™šä¸Š", value: pom.evening || 0, color: "#7AA2FF" }
            ];
            const maxVal = Math.max(...bestArr.map(x => x.value));
            const bestPeriods = maxVal > 0 ? bestArr.filter(x => x.value === maxVal) : [];
            const bestPeriod = bestPeriods.length > 0 ? bestPeriods.map(x => x.label).join("ã€") : "â€”";

            // æ›´æ–°å¡ç‰‡
            document.getElementById("pomSummaryTotal").textContent = pomSummaryTotal;
            document.getElementById("pomSummaryHour").textContent = pomSummaryHour;
            document.getElementById("pomSummaryScore").textContent = pomSummaryScore;
            const bestDiv = document.getElementById("pomSummaryBest");
            bestDiv.textContent = bestPeriod;
            // è®¾ç½®å­—ä½“é¢œè‰²
            if (bestPeriods.length === 1) {
                bestDiv.style.background = '';
                bestDiv.style.color = bestPeriods[0].color;
            } else if (bestPeriods.length > 1) {
                // å¤šä¸ªæœ€ä½³æ—¶æ®µï¼Œä½¿ç”¨çº¿æ€§æ¸å˜è‰²
                const colors = bestPeriods.map(x => x.color).join(', ');
                bestDiv.style.background = `linear-gradient(90deg, ${colors})`;
                bestDiv.style.webkitBackgroundClip = 'text';
                bestDiv.style.backgroundClip = 'text';
                bestDiv.style.color = 'transparent';
            } else {
                bestDiv.style.background = '';
                bestDiv.style.color = '';
            }
            pomDateLabel.textContent = key;

            const parts = ["morning", "noon", "evening"];
            parts.forEach(p => {
                const n = pom[p] || 0;
                document.getElementById(`pom_${p}_n`).textContent = n;
                const tomatoBox = document.getElementById(`pom_${p}`);
                tomatoBox.innerHTML = tomatoes(n);
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ç°è‰²ç•ªèŒ„æ·»åŠ 
                tomatoBox.querySelectorAll('.tomato-empty').forEach(el => {
                    el.onclick = () => {
                        const key = ymd(selectedDate);
                        const pom = dayData(key).pomodoro;
                        pom[p] = clamp((pom[p] || 0) + 1, 0, 8);
                        saveDBInternal();
                        renderPomodoro();
                    };
                });
            });

            const data = [];
            for (let i = 9; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const k = ymd(d);
                const pp = dayData(k).pomodoro;
                const morning = pp.morning || 0;
                const noon = pp.noon || 0;
                const evening = pp.evening || 0;
                data.push({
                    k,
                    morning,
                    noon,
                    evening,
                    morningHour: +(morning * 25 / 60).toFixed(2),
                    noonHour: +(noon * 25 / 60).toFixed(2),
                    eveningHour: +(evening * 25 / 60).toFixed(2),
                    hourTotal: +((morning + noon + evening) * 25 / 60).toFixed(2)
                });
            }
            drawPomChart(data);

        }

        /* =========================
           ç¡çœ ï¼šç®­å¤´æ­¥è¿›
        ========================= */
        const sleepDateLabel = document.getElementById("sleepDateLabel");
        const wakeDisp = document.getElementById("wakeDisp");
        const bedDisp = document.getElementById("bedDisp");
        const sleepDur = document.getElementById("sleepDur");
        const sleepAvg7 = document.getElementById("sleepAvg7");
        const sleepAvgTime = document.getElementById("sleepAvgTime");
        const sleepChart = document.getElementById("sleepChart");
        const sctx = sleepChart.getContext("2d");

        document.getElementById("sleepPrevDay").onclick = () => { selectedDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() - 1); renderSleep(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("sleepNextDay").onclick = () => { selectedDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() + 1); renderSleep(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("sleepToday").onclick = () => { selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()); renderSleep(); renderAllHome(); renderStatsDayLabel(); renderStats(); };
        document.getElementById("sleepClear").onclick = () => {
            const key = ymd(selectedDate);
            if (!confirm(`ç¡®å®šæ¸…ç©º ${key} çš„èµ·åºŠä¸å…¥ç¡è®°å½•å—ï¼Ÿ`)) return;
            dayData(key).sleep = { wake: "", bed: "" };
            saveDBInternal();
            renderSleep();
        };
        document.getElementById("sleepSave").onclick = () => {
            const key = ymd(selectedDate);
            dayData(key).sleep = { wake: wakeDisp.textContent, bed: bedDisp.textContent };
            saveDBInternal();
            renderSleep();
        };

        function attachStepper(btnUp, btnDown, getVal, setVal, step = 5) {
            const make = (el, delta) => {
                let holdTimer = null;
                let repeatTimer = null;
                let active = false;

                const bump = () => setVal(((getVal() ?? 0) + delta + 1440) % 1440);

                const stop = () => {
                    if (!active) return;
                    active = false;
                    clearTimeout(holdTimer);
                    clearInterval(repeatTimer);
                    holdTimer = null;
                    repeatTimer = null;
                };

                el.addEventListener("pointerdown", (e) => {
                    e.preventDefault();
                    active = true;
                    el.setPointerCapture?.(e.pointerId);
                    bump(); // ç«‹å³å•æ­¥
                    // æŒ‰ä½ä¸€ä¼šå†å¼€å§‹è¿å‘
                    holdTimer = setTimeout(() => {
                        repeatTimer = setInterval(bump, 90);
                    }, 260);
                });

                el.addEventListener("pointerup", stop);
                el.addEventListener("pointercancel", stop);
                el.addEventListener("pointerleave", stop);
                window.addEventListener("blur", stop);
            };

            make(btnUp, +step);
            make(btnDown, -step);
        }

        let wakeMinCache = 7 * 60 + 30;
        let bedMinCache = 23 * 60 + 30;

        function renderSleepStatsOnly() {
            const dur = minutesBetween(bedMinCache, wakeMinCache);
            sleepDur.textContent = fmtDuration(dur);
        }

        attachStepper(
            document.getElementById("wakeUp"),
            document.getElementById("wakeDown"),
            () => wakeMinCache,
            (v) => { wakeMinCache = v; wakeDisp.textContent = minToTime(v); renderSleepStatsOnly(); },
            5
        );
        attachStepper(
            document.getElementById("bedUp"),
            document.getElementById("bedDown"),
            () => bedMinCache,
            (v) => { bedMinCache = v; bedDisp.textContent = minToTime(v); renderSleepStatsOnly(); },
            5
        );

        // ç¡çœ ç»Ÿè®¡å›¾ï¼šè“è‰²æŸ±çŠ¶å›¾ï¼Œçºµè½´å°æ—¶ï¼Œæ¨ªè½´æ—¥æœŸï¼Œç‚¹å‡»æ˜¾ç¤ºå…·ä½“æ—¶é•¿
        let sleepBarHitBoxes = [];
        function drawSleepChart(arr) {
            const ctx = sctx, canvas = sleepChart;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

            const padL = 48, padR = 12, padT = 24, padB = 38;
            const W = canvas.width - padL - padR;
            const H = canvas.height - padT - padB;

            const vals = arr.map(x => x.dur).filter(x => x != null);
            const maxV = Math.max(1, ...(vals.length ? vals : [1]));
            const maxHour = Math.ceil(maxV / 60);
            const barW = W / arr.length;
            sleepBarHitBoxes = [];

            // ç”»æ¨ªè½´
            ctx.strokeStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.10)" : "rgba(255,255,255,.10)";
            ctx.beginPath();
            ctx.moveTo(padL, padT + H);
            ctx.lineTo(padL + W, padT + H);
            ctx.stroke();

            // ç”»çºµè½´åˆ»åº¦ï¼ˆå°æ—¶ï¼‰
            ctx.font = "13px sans-serif";
            ctx.fillStyle = "#888";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            for (let i = 0; i <= maxHour; i++) {
                const y = padT + H - (H * (i / maxHour));
                ctx.fillText(i + "h", padL - 8, y);
                // æ¨ªçº¿
                ctx.strokeStyle = "#e0e7ef";
                ctx.beginPath();
                ctx.moveTo(padL, y);
                ctx.lineTo(padL + W, y);
                ctx.stroke();
            }

            // ç”»æŸ±çŠ¶å›¾ï¼ˆè“è‰²ï¼‰
            for (let i = 0; i < arr.length; i++) {
                const v = arr[i].dur;
                const x = padL + i * barW + 2;
                if (v == null) {
                    ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.08)" : "rgba(255,255,255,.10)";
                    ctx.fillRect(x, padT + H - 10, Math.max(2, barW - 4), 10);
                    continue;
                }
                const h = (v / (maxHour * 60)) * (H * 0.9);
                ctx.fillStyle = "#3b6cff";
                ctx.globalAlpha = 0.85;
                ctx.fillRect(x, padT + (H - h), Math.max(8, barW - 8), h);
                ctx.globalAlpha = 1;
                // è®°å½•ç‚¹å‡»åŒºåŸŸ
                sleepBarHitBoxes.push({ x, y: padT + (H - h), w: Math.max(8, barW - 8), h, idx: i });
            }

            // æ—¥æœŸæ ‡ç­¾
            ctx.save();
            ctx.font = "12px sans-serif";
            ctx.fillStyle = "#888";
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            for (let i = 0; i < arr.length; i++) {
                const x = padL + i * barW + barW / 2;
                const label = arr[i].k.slice(5); // MM-DD
                ctx.fillText(label, x, padT + H + 6);
            }
            ctx.restore();

            // æ ‡é¢˜
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.85)" : "rgba(233,238,252,.85)";
            setCanvasFont(ctx, 13, 600);
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
        }

        // ç‚¹å‡»æŸ±çŠ¶å›¾æ˜¾ç¤ºå…·ä½“ç¡çœ æ—¶é•¿
        sleepChart.addEventListener("click", function (ev) {
            const rect = sleepChart.getBoundingClientRect();
            const x = (ev.clientX - rect.left) * (sleepChart.width / rect.width);
            const y = (ev.clientY - rect.top) * (sleepChart.height / rect.height);
            for (const hb of sleepBarHitBoxes) {
                if (x >= hb.x && x <= hb.x + hb.w && y >= hb.y && y <= hb.y + hb.h) {
                    // è·å–æ•°æ®
                    const arr = [];
                    for (let i = 13; i >= 0; i--) {
                        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                        const k = ymd(d);
                        const sl = dayData(k).sleep;
                        const dd = minutesBetween(timeToMin(sl.bed), timeToMin(sl.wake));
                        arr.push({ k, dur: dd });
                    }
                    const item = arr[hb.idx];
                    if (item && item.dur != null) {
                        alert(item.k + "\nç¡çœ æ—¶é•¿ï¼š" + fmtDuration(item.dur));
                    } else if (item) {
                        alert(item.k + "\næ— æœ‰æ•ˆæ•°æ®");
                    }
                    return;
                }
            }
        });

        function renderSleep() {
            const key = ymd(selectedDate);
            sleepDateLabel.textContent = key;
            const sleep = dayData(key).sleep;

            wakeMinCache = timeToMin(sleep.wake) ?? (7 * 60 + 30);
            bedMinCache = timeToMin(sleep.bed) ?? (23 * 60 + 30);
            wakeDisp.textContent = minToTime(wakeMinCache);
            bedDisp.textContent = minToTime(bedMinCache);

            renderSleepStatsOnly();

            const recent = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const k = ymd(d);
                const sl = dayData(k).sleep;
                const dd = minutesBetween(timeToMin(sl.bed), timeToMin(sl.wake));
                if (dd != null) recent.push({ k, dur: dd, bed: timeToMin(sl.bed), wake: timeToMin(sl.wake) });
            }
            if (recent.length) {
                const avg = Math.round(recent.reduce((a, b) => a + b.dur, 0) / recent.length);
                sleepAvg7.textContent = fmtDuration(avg);
                const avgBed = Math.round(recent.reduce((a, b) => a + (b.bed ?? 0), 0) / recent.length);
                const avgWake = Math.round(recent.reduce((a, b) => a + (b.wake ?? 0), 0) / recent.length);
                sleepAvgTime.textContent = `${minToTime(avgWake)} / ${minToTime(avgBed)}`;
            } else {
                sleepAvg7.textContent = "â€”";
                sleepAvgTime.textContent = "â€”";
            }

            const arr = [];
            for (let i = 13; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const k = ymd(d);
                const sl = dayData(k).sleep;
                const dd = minutesBetween(timeToMin(sl.bed), timeToMin(sl.wake));
                arr.push({ k, dur: dd });
            }
            drawSleepChart(arr);
        }

        /* =========================
           å¿«é€Ÿæ–°å¢ä»»åŠ¡ç±»å‹
        ========================= */
        const typeMask = document.getElementById("typeMask");
        const btnQuickAddType = document.getElementById("btnQuickAddType");
        const typeClose = document.getElementById("typeClose");
        const typeCancel = document.getElementById("typeCancel");
        const typeCreate = document.getElementById("typeCreate");
        const typeName = document.getElementById("typeName");
        const typeColor = document.getElementById("typeColor");

        function openTypeModal() {
            typeName.value = "";
            typeColor.value = getCSS("--accent") || "#7aa2ff";
            typeMask.classList.add("show");
            typeName.focus();
        }
        function closeTypeModal() { typeMask.classList.remove("show"); }

        btnQuickAddType.onclick = (e) => { e.preventDefault(); openTypeModal(); };
        typeClose.onclick = closeTypeModal;
        typeCancel.onclick = closeTypeModal;
        typeMask.addEventListener("click", (e) => { if (e.target === typeMask) closeTypeModal(); });

        typeCreate.onclick = () => {
            const name = (typeName.value || "").trim();
            const color = typeColor.value || (getCSS("--accent") || "#7aa2ff");
            if (!name) { alert("è¯·å¡«å†™ç±»å‹åç§°"); return; }
            const exists = db.taskTypes.list.some(t => t.name === name);
            if (exists && !confirm("å·²æœ‰åŒåç±»å‹ï¼Œä»è¦åˆ›å»ºå—ï¼Ÿ")) return;

            const id = "t_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
            db.taskTypes.list.push({ id, name, color, created: nowYMD() });
            saveDBInternal();

            renderTypeOptions(actType, id);
            syncTypeBadge();

            closeTypeModal();
            renderAllHome();
            renderStats();
        };

        /* =========================
           ä»»åŠ¡ç»Ÿè®¡ï¼šæŒ‰å¤© + é¥¼å›¾ / æŒ‰ç±»åˆ«
        ========================= */
        const statsModeSeg = document.getElementById("statsModeSeg");
        const statsRange = document.getElementById("statsRange");
        const statsCategory = document.getElementById("statsCategory");
        const statsTitle = document.getElementById("statsTitle");
        const statsHint = document.getElementById("statsHint");
        const statsPieTitle = document.getElementById("statsPieTitle");
        const statsPieHint = document.getElementById("statsPieHint");
        const statsLegend = document.getElementById("statsLegend");

        const statsBar = document.getElementById("statsBar");
        const sbctx = statsBar.getContext("2d");
        const statsPie = document.getElementById("statsPie");
        const spctx = statsPie.getContext("2d");

        const statsDayLabel = document.getElementById("statsDayLabel");
        const statsPrevDay = document.getElementById("statsPrevDay");
        const statsNextDay = document.getElementById("statsNextDay");
        const statsUseSelected = document.getElementById("statsUseSelected");
        const statsRefresh = document.getElementById("statsRefresh");

        let statsMode = "byday";
        let statsDayKey = ymd(selectedDate);

        function renderStatsDayLabel() {
            statsDayKey = statsDayKey || ymd(selectedDate);
            statsDayLabel.textContent = statsDayKey;
        }

        statsModeSeg.querySelectorAll(".tab").forEach(t => {
            t.addEventListener("click", () => {
                statsModeSeg.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
                t.classList.add("active");
                statsMode = t.dataset.statsMode;
                renderStats();
            });
        });
        statsRange.onchange = () => renderStats();
        statsCategory.onchange = () => renderStats();
        statsRefresh.onclick = () => renderStats();

        statsUseSelected.onclick = () => {
            statsDayKey = ymd(selectedDate);
            renderStatsDayLabel();
            renderStats();
        };
        statsPrevDay.onclick = () => {
            const d = parseYMD(statsDayKey);
            statsDayKey = ymd(new Date(d.getFullYear(), d.getMonth(), d.getDate() - 1));
            renderStatsDayLabel();
            renderStats();
        };
        statsNextDay.onclick = () => {
            const d = parseYMD(statsDayKey);
            statsDayKey = ymd(new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1));
            renderStatsDayLabel();
            renderStats();
        };

        function buildLegend() {
            statsLegend.innerHTML = db.taskTypes.list.map(t => {
                return `<div class="legend-item"><span class="sw" style="background:${t.color}"></span>${escapeHtml(t.name)}</div>`;
            }).join("");
        }
        function renderCategorySelect() {
            const cur = statsCategory.value || "uncat";
            renderTypeOptions(statsCategory, cur);
        }

        function sumMinutesForTypeOnDay(dayKey, typeId) {
            const acts = getActivities(dayKey);
            return acts
                .filter(a => (a.typeId || "uncat") === typeId)
                .reduce((s, a) => s + (a.endMin - a.startMin), 0);
        }
        function sumMinutesByTypeOnDay(dayKey) {
            const acts = getActivities(dayKey);
            const map = new Map();
            for (const a of acts) {
                const id = a.typeId || "uncat";
                map.set(id, (map.get(id) || 0) + (a.endMin - a.startMin));
            }
            if (!map.size) map.set("uncat", 0);
            return map;
        }
        function lastNDays(n) {
            const out = [];
            for (let i = n - 1; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                out.push(ymd(d));
            }
            return out;
        }

        let barHitBoxes = [];
        statsBar.addEventListener("click", (ev) => {
            if (statsMode !== "byday") return;
            const rect = statsBar.getBoundingClientRect();
            const x = (ev.clientX - rect.left) * (statsBar.width / rect.width);
            const y = (ev.clientY - rect.top) * (statsBar.height / rect.height);
            for (const hb of barHitBoxes) {
                if (x >= hb.x && x <= hb.x + hb.w && y >= hb.y && y <= hb.y + hb.h) {
                    statsDayKey = hb.dayKey;
                    renderStatsDayLabel();
                    drawStatsPieForDay(statsDayKey);
                    return;
                }
            }
        });

        function drawStatsBarByDay(days, typeId) {
            const ctx = sbctx, canvas = statsBar;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            barHitBoxes = [];

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

            const padL = 44, padR = 16, padT = 22, padB = 28;
            const W = canvas.width - padL - padR;
            const H = canvas.height - padT - padB;

            const vals = days.map(k => sumMinutesForTypeOnDay(k, typeId));
            const maxV = Math.max(1, ...vals);
            const barW = W / days.length;

            ctx.strokeStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.10)" : "rgba(255,255,255,.10)";
            ctx.beginPath(); ctx.moveTo(padL, padT + H); ctx.lineTo(padL + W, padT + H); ctx.stroke();

            const col = getTypeColor(typeId);

            for (let i = 0; i < days.length; i++) {
                const v = vals[i];
                const h = (v / maxV) * (H * 0.9);
                const x = padL + i * barW + 2;
                const y = padT + (H - h);
                const w = Math.max(2, barW - 4);

                ctx.fillStyle = col;
                ctx.globalAlpha = (days[i] === statsDayKey) ? 0.95 : 0.60;
                ctx.fillRect(x, y, w, h);
                ctx.globalAlpha = 1;

                barHitBoxes.push({ x, y, w, h, dayKey: days[i] });
            }

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.88)" : "rgba(233,238,252,.88)";
            setCanvasFont(ctx, 12, 600);
            ctx.fillText(`è¿‘ ${days.length} å¤©ï¼š${getType(typeId).name}ï¼ˆåˆ†é’Ÿï¼‰`, padL, 18);

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
            setCanvasFont(ctx, 11, 500);
            ctx.fillText(days[0], padL, canvas.height - 8);
            ctx.fillText(days[days.length - 1], padL + W - 78, canvas.height - 8);
        }

        function drawStatsBarByCategory(days) {
            const ctx = sbctx, canvas = statsBar;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

            const padL = 190, padR = 16, padT = 22, padB = 22;
            const W = canvas.width - padL - padR;
            const H = canvas.height - padT - padB;

            const totals = db.taskTypes.list.map(t => {
                let s = 0;
                for (const k of days) s += sumMinutesForTypeOnDay(k, t.id);
                return { id: t.id, name: t.name, color: t.color, v: s };
            }).filter(x => x.v > 0 || x.id === "uncat");

            const maxV = Math.max(1, ...totals.map(x => x.v));
            const rowH = H / Math.max(1, totals.length);

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.88)" : "rgba(233,238,252,.88)";
            setCanvasFont(ctx, 12, 600);
            ctx.fillText(`è¿‘ ${days.length} å¤©ï¼šæŒ‰ç±»åˆ«æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰`, 44, 18);

            for (let i = 0; i < totals.length; i++) {
                const y = padT + i * rowH + 6;
                const h = Math.max(12, rowH - 12);
                const w = (totals[i].v / maxV) * (W * 0.95);

                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.75)" : "rgba(233,238,252,.75)";
                setCanvasFont(ctx, 11, 600);
                ctx.fillText(totals[i].name, 44, y + h * 0.72);

                ctx.fillStyle = totals[i].color;
                ctx.globalAlpha = 0.60;
                ctx.fillRect(padL, y, w, h);
                ctx.globalAlpha = 1;

                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
                setCanvasFont(ctx, 11, 500);
                ctx.fillText(`${totals[i].v}`, padL + w + 8, y + h * 0.72);
            }
        }

        function drawStatsPieForDay(dayKey) {
            const ctx = spctx, canvas = statsPie;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
            roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

            const map = sumMinutesByTypeOnDay(dayKey);
            const items = [];
            for (const [id, v] of map.entries()) {
                if (v > 0) items.push({ id, v, color: getTypeColor(id), name: getType(id).name });
            }
            const total = items.reduce((s, x) => s + x.v, 0);

            statsPieHint.textContent = total ? `æ€»è®°å½•ï¼š${fmtDuration(total)}ï¼ˆä¸å«ç©ºç™½æ—¶é—´ï¼‰` : "å½“æ—¥æš‚æ— æ´»åŠ¨è®°å½•";
            statsPieTitle.textContent = `å½“æ—¥ç±»åˆ«åˆ†å¸ƒï¼ˆ${dayKey}ï¼‰`;

            const cx = canvas.width * 0.28;
            const cy = canvas.height * 0.53;
            const r = Math.min(canvas.height, canvas.width) * 0.28;

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.88)" : "rgba(233,238,252,.88)";
            setCanvasFont(ctx, 12, 600);
            ctx.fillText("é¥¼å›¾ï¼šæ—¶é—´å æ¯”", 44, 18);

            if (!items.length) {
                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
                setCanvasFont(ctx, 12, 500);
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("æš‚æ— å¯ç»Ÿè®¡æ•°æ®", cx, cy);
                ctx.textAlign = "start";
                ctx.textBaseline = "alphabetic";
                return;
            }

            let start = -Math.PI / 2;
            for (const it of items) {
                const ang = (it.v / total) * Math.PI * 2;
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, start, start + ang);
                ctx.closePath();
                ctx.fillStyle = it.color;
                ctx.globalAlpha = 0.72;
                ctx.fill();
                ctx.globalAlpha = 1;
                start += ang;
            }

            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.88)" : "rgba(233,238,252,.88)";
            setCanvasFont(ctx, 12, 700);
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(`${Math.round(total / 60)} å°æ—¶`, cx, cy - 6);
            ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
            setCanvasFont(ctx, 11, 500);
            ctx.fillText("ï¼ˆå·²è®°å½•ï¼‰", cx, cy + 12);
            ctx.textAlign = "start";
            ctx.textBaseline = "alphabetic";

            const lx = canvas.width * 0.55;
            let ly = 58;
            for (const it of items.sort((a, b) => b.v - a.v)) {
                const pct = Math.round((it.v / total) * 100);
                ctx.fillStyle = it.color;
                ctx.globalAlpha = 0.85;
                ctx.beginPath(); ctx.arc(lx, ly, 6, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1;

                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(19,25,39,.85)" : "rgba(233,238,252,.85)";
                setCanvasFont(ctx, 12, 600);
                ctx.fillText(`${it.name}`, lx + 14, ly + 4);

                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(90,103,134,.95)" : "rgba(169,179,204,.9)";
                setCanvasFont(ctx, 11, 500);
                ctx.fillText(`${fmtDuration(it.v)} Â· ${pct}%`, lx + 140, ly + 4);

                ly += 24;
                if (ly > canvas.height - 20) break;
            }
        }

        function renderStats() {
            buildLegend();
            renderCategorySelect();
            renderStatsDayLabel();

            const n = Number(statsRange.value || 14);
            const days = lastNDays(n);

            if (statsMode === "byday") {
                const typeId = statsCategory.value || "uncat";
                statsTitle.textContent = "æŒ‰å¤©ç»Ÿè®¡ï¼ˆæŸä¸€ç±»ä»»åŠ¡ï¼‰";
                statsHint.textContent = `ç±»åˆ«ï¼š${getType(typeId).name} Â· ç‚¹å‡»æŸ±å­å¯åˆ‡æ¢é¥¼å›¾æ—¥æœŸ`;
                drawStatsBarByDay(days, typeId);
                drawStatsPieForDay(statsDayKey);
            } else {
                statsTitle.textContent = "æŒ‰ç±»åˆ«ç»Ÿè®¡ï¼ˆåŒºé—´æ±‡æ€»ï¼‰";
                statsHint.textContent = `èŒƒå›´ï¼šè¿‘ ${n} å¤©ï¼ˆå³ä¾§é¥¼å›¾ä»æ˜¾ç¤ºé€‰ä¸­æ—¥ï¼‰`;
                drawStatsBarByCategory(days);
                drawStatsPieForDay(statsDayKey);
            }
        }

        /* =========================
           æ•°æ®ï¼šå¯¼å…¥/å¯¼å‡º/è‡ªåŠ¨å­˜æ¡£
        ========================= */
        const dataBtn = document.getElementById("dataBtn");
        const dataMask = document.getElementById("dataMask");
        const dataClose = document.getElementById("dataClose");
        const dataOk = document.getElementById("dataOk");
        const exportBtn = document.getElementById("exportBtn");
        const importFile = document.getElementById("importFile");
        const resetLocalBtn = document.getElementById("resetLocalBtn");

        const pickArchiveBtn = document.getElementById("pickArchiveBtn");
        const syncNowBtn = document.getElementById("syncNowBtn");
        const toggleAutoSyncBtn = document.getElementById("toggleAutoSyncBtn");
        const archiveStatus = document.getElementById("archiveStatus");

        let syncCfg = loadSyncCfg(); // { enabled: boolean }
        let archiveHandle = null;

        function openDataModal() {
            dataMask.classList.add("show");
            updateArchiveStatus();
        }
        function closeDataModal() {
            dataMask.classList.remove("show");
        }
        dataBtn.onclick = openDataModal;
        dataClose.onclick = closeDataModal;
        dataOk.onclick = closeDataModal;
        dataMask.addEventListener("click", (e) => { if (e.target === dataMask) closeDataModal(); });

        function downloadJSON(filename, obj) {
            const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        exportBtn.onclick = () => {
            downloadJSON(`tracker-backup-${nowYMD()}.json`, db);
        };

        resetLocalBtn.onclick = () => {
            if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬åœ°æ•°æ®å—ï¼Ÿï¼ˆä¸ä¼šåˆ é™¤ä½ å¯¼å‡ºçš„æ–‡ä»¶ï¼‰")) return;
            db = loadDB(); // é‡æ–°åˆå§‹åŒ–é»˜è®¤ç»“æ„
            saveDBInternal();
            redrawAll();
            renderStats();
            alert("å·²æ¸…ç©ºæœ¬åœ°æ•°æ®ã€‚");
        };

        importFile.onchange = async () => {
            const file = importFile.files?.[0];
            if (!file) return;

            // å¯¼å…¥å‰å…ˆå¤‡ä»½
            downloadJSON(`tracker-preimport-backup-${nowYMD()}.json`, db);

            try {
                const text = await file.text();
                const parsed = JSON.parse(text);
                db = parsed;
                // åŸºæœ¬å­—æ®µå…œåº•
                db.days ||= {};
                db.habits ||= { list: [], records: {} };
                db.taskTypes ||= { list: [] };
                if (!db.taskTypes.list?.length) {
                    db.taskTypes.list = [
                        { id: "uncat", name: "æœªåˆ†ç±»", color: getCSS("--accent") || "#7aa2ff", created: nowYMD() }
                    ];
                }
                saveDBInternal();
                redrawAll();
                renderStats();
                alert("å¯¼å…¥æˆåŠŸï¼ˆå·²è¦†ç›–å½“å‰æ•°æ®ï¼‰ã€‚");
            } catch (err) {
                console.error(err);
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆ JSON æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
            } finally {
                importFile.value = "";
            }
        };

        function supportsFSAccess() {
            return !!(window.showOpenFilePicker && window.showSaveFilePicker);
        }

        async function loadArchiveHandle() {
            try {
                archiveHandle = await idbGet("archiveHandle");
            } catch {
                archiveHandle = null;
            }
        }

        async function setArchiveHandle(handle) {
            archiveHandle = handle;
            await idbSet("archiveHandle", handle);
        }

        async function ensureArchivePermission(mode = "readwrite") {
            if (!archiveHandle) return false;
            try {
                const q = await archiveHandle.queryPermission({ mode });
                if (q === "granted") return true;
                const r = await archiveHandle.requestPermission({ mode });
                return r === "granted";
            } catch {
                return false;
            }
        }

        async function readArchiveIntoDB() {
            if (!archiveHandle) throw new Error("no handle");
            const ok = await ensureArchivePermission("read");
            if (!ok) throw new Error("permission denied");
            const file = await archiveHandle.getFile();
            const text = await file.text();
            const parsed = JSON.parse(text);
            db = parsed;
            db.days ||= {};
            db.habits ||= { list: [], records: {} };
            db.taskTypes ||= { list: [] };
            if (!db.taskTypes.list?.length) {
                db.taskTypes.list = [{ id: "uncat", name: "æœªåˆ†ç±»", color: getCSS("--accent") || "#7aa2ff", created: nowYMD() }];
            }
            saveDBInternal(); // å†™å…¥ localStorage & è§¦å‘è‡ªåŠ¨å†™å…¥
        }

        async function writeDBToArchive() {
            if (writing) return;
            if (!syncCfg.enabled) return;
            if (!archiveHandle) return;
            const ok = await ensureArchivePermission("readwrite");
            if (!ok) return;

            writing = true;
            try {
                const writable = await archiveHandle.createWritable();
                await writable.write(JSON.stringify(db, null, 2));
                await writable.close();
                lastWriteTs = Date.now();
                updateArchiveStatus("å·²è‡ªåŠ¨åŒæ­¥");
            } catch (err) {
                console.error(err);
                updateArchiveStatus("è‡ªåŠ¨åŒæ­¥å¤±è´¥ï¼ˆæƒé™æˆ–æ–‡ä»¶ä¸å¯å†™ï¼‰");
            } finally {
                writing = false;
            }
        }

        function scheduleAutoWrite() {
            if (!syncCfg.enabled) return;
            if (!archiveHandle) return;
            clearTimeout(autoWriteTimer);
            autoWriteTimer = setTimeout(writeDBToArchive, 450);
        }

        function updateArchiveStatus(extra = null) {
            const fs = supportsFSAccess();
            const enabled = !!syncCfg.enabled;
            toggleAutoSyncBtn.textContent = `è‡ªåŠ¨åŒæ­¥ï¼š${enabled ? "å¼€" : "å…³"}`;

            if (!fs) {
                archiveStatus.textContent = "çŠ¶æ€ï¼šå½“å‰æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å­˜æ¡£ï¼ˆå¯ä½¿ç”¨å¯¼å…¥/å¯¼å‡ºï¼‰";
                pickArchiveBtn.disabled = true;
                syncNowBtn.disabled = true;
                toggleAutoSyncBtn.disabled = true;
                return;
            } else {
                pickArchiveBtn.disabled = false;
                syncNowBtn.disabled = false;
                toggleAutoSyncBtn.disabled = false;
            }

            if (!archiveHandle) {
                archiveStatus.textContent = "çŠ¶æ€ï¼šæœªè®¾ç½®å­˜æ¡£æ–‡ä»¶";
                return;
            }
            const base = `çŠ¶æ€ï¼šå·²è®¾ç½®å­˜æ¡£æ–‡ä»¶ Â· è‡ªåŠ¨åŒæ­¥${enabled ? "å·²å¼€å¯" : "æœªå¼€å¯"}`;
            const suffix = extra ? ` Â· ${extra}` : "";
            const time = lastWriteTs ? ` Â· ä¸Šæ¬¡å†™å…¥ï¼š${new Date(lastWriteTs).toLocaleString()}` : "";
            archiveStatus.textContent = base + suffix + time;
        }

        toggleAutoSyncBtn.onclick = () => {
            if (!supportsFSAccess()) {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å­˜æ¡£åŠŸèƒ½ã€‚");
                return;
            }
            syncCfg.enabled = !syncCfg.enabled;
            saveSyncCfg(syncCfg);
            updateArchiveStatus();
            if (syncCfg.enabled) scheduleAutoWrite();
        };

        pickArchiveBtn.onclick = async () => {
            if (!supportsFSAccess()) {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å­˜æ¡£åŠŸèƒ½ã€‚");
                return;
            }
            try {
                // è®©ç”¨æˆ·é€‰æ‹©å·²æœ‰æ–‡ä»¶æˆ–æ–°å»ºæ–‡ä»¶
                const useNew = confirm("æ˜¯å¦åˆ›å»ºä¸€ä¸ªæ–°çš„å­˜æ¡£æ–‡ä»¶ï¼Ÿ\nç¡®å®š=åˆ›å»ºæ–°æ–‡ä»¶ï¼›å–æ¶ˆ=é€‰æ‹©å·²æœ‰æ–‡ä»¶");
                let handle;
                if (useNew) {
                    handle = await window.showSaveFilePicker({
                        suggestedName: `tracker-archive.json`,
                        types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
                    });
                } else {
                    const [h] = await window.showOpenFilePicker({
                        multiple: false,
                        types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
                    });
                    handle = h;
                }
                await setArchiveHandle(handle);
                syncCfg.enabled = true;
                saveSyncCfg(syncCfg);
                updateArchiveStatus("å·²é€‰æ‹©å­˜æ¡£");
                // ç«‹å³å†™å…¥ä¸€æ¬¡å½“å‰æ•°æ®ï¼ˆé¿å…ç©ºæ–‡ä»¶/æ—§æ–‡ä»¶ï¼‰
                await writeDBToArchive();
            } catch (err) {
                console.error(err);
                alert("é€‰æ‹©/åˆ›å»ºå­˜æ¡£å¤±è´¥æˆ–è¢«å–æ¶ˆã€‚");
            }
        };

        syncNowBtn.onclick = async () => {
            if (!archiveHandle) {
                alert("è¯·å…ˆé€‰æ‹©/åˆ›å»ºä¸€ä¸ªå­˜æ¡£æ–‡ä»¶ã€‚");
                return;
            }
            await writeDBToArchive();
        };

        /* å¯åŠ¨æ—¶ï¼šå°è¯•åŠ è½½å­˜æ¡£å¹¶è‡ªåŠ¨åŒæ­¥ */
        async function initAutoSync() {
            await loadArchiveHandle();
            updateArchiveStatus();

            // è‹¥å¼€å¯è‡ªåŠ¨åŒæ­¥ä¸”æœ‰ handleï¼Œå°è¯•è¯»å–
            if (syncCfg.enabled && archiveHandle) {
                try {
                    const ok = await ensureArchivePermission("read");
                    if (ok) {
                        await readArchiveIntoDB();
                        updateArchiveStatus("å·²ä»å­˜æ¡£è¯»å–");
                    } else {
                        updateArchiveStatus("æœªè·å¾—è¯»å–æƒé™");
                    }
                } catch (err) {
                    // å¦‚æœå­˜æ¡£ä¸ºç©ºæˆ– JSON ä¸åˆæ³•ï¼Œä¸é˜»å¡ä½¿ç”¨
                    console.warn("archive read failed:", err);
                    updateArchiveStatus("å­˜æ¡£è¯»å–å¤±è´¥ï¼ˆå¯èƒ½ä¸ºç©º/éJSONï¼‰");
                }
            }
        }

        /* =========================
           åˆå§‹åŒ–é»˜è®¤ç»Ÿè®¡é¡µæ—¥æœŸ
        ========================= */
        statsDayKey = ymd(selectedDate);
        renderStatsDayLabel();

        /* =========================
           ç»Ÿä¸€é‡ç»˜
        ========================= */
        function redrawAll(onlyPage = null) {
            // onlyPage å¯é€‰ï¼›ä½†è¿™é‡Œç®€å•éƒ½ç”»ä¸€æ¬¡ï¼Œä¿æŒä¸€è‡´
            renderAllHome();
            renderHabits();
            renderPomodoro();
            renderSleep();
            renderStats();
        }

        /* =========================
           åˆå§‹åŒ–
        ========================= */
        (function init() {
            // ç•ªèŒ„é’Ÿæ—¥æœŸé€‰æ‹©å¼¹çª—é€»è¾‘ï¼ˆåˆå¹¶åˆ°ä¸»ä½œç”¨åŸŸï¼Œé¿å…å˜é‡é‡å¤ï¼‰
            const pomDateLabel = document.getElementById("pomDateLabel");
            const pomDateMask = document.getElementById("pomDateMask");
            const pomDatePicker = document.getElementById("pomDatePicker");
            const pomDateClose = document.getElementById("pomDateClose");
            const pomDateOk = document.getElementById("pomDateOk");
            if (pomDateLabel && pomDateMask && pomDatePicker && pomDateClose && pomDateOk) {
                pomDateLabel.addEventListener("click", () => {
                    // è®¾ç½®å½“å‰æ—¥æœŸåˆ°é€‰æ‹©å™¨
                    const ymdStr = ymd(selectedDate);
                    pomDatePicker.value = ymdStr;
                    pomDateMask.classList.add("show");
                });
                pomDateClose.onclick = () => pomDateMask.classList.remove("show");
                pomDateMask.addEventListener("click", (e) => { if (e.target === pomDateMask) pomDateMask.classList.remove("show"); });
                pomDateOk.onclick = () => {
                    const val = pomDatePicker.value;
                    if (val) {
                        const [y, m, d] = val.split("-").map(Number);
                        selectedDate = new Date(y, m - 1, d);
                        pomDateMask.classList.remove("show");
                        renderPomodoro();
                        if (typeof renderAllHome === 'function') renderAllHome();
                        if (typeof renderStatsDayLabel === 'function') renderStatsDayLabel();
                        if (typeof renderStats === 'function') renderStats();
                    }
                };
            }
            habitStartDate.value = ymd(today);

            if (db.habits.list.length && !selectedHabitId) {
                selectedHabitId = db.habits.list[0].id;
            }
            function drawSleepTimeLineChart() {
                const canvas = document.getElementById("sleepTimeLineChart");
                if (!canvas) return;
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                // èƒŒæ™¯
                ctx.fillStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.03)" : "rgba(255,255,255,.03)";
                roundRect(ctx, 10, 10, canvas.width - 20, canvas.height - 20, 14, true, false);

                const padL = 48, padR = 12, padT = 24, padB = 38;
                const W = canvas.width - padL - padR;
                const H = canvas.height - padT - padB;
                // æ¨ªè½´
                const arr = [];
                for (let i = 13; i >= 0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                    const k = ymd(d);
                    const sl = dayData(k).sleep;
                    arr.push({
                        k,
                        bed: timeToMin(sl.bed) != null ? (
                            (timeToMin(sl.bed) < 6 * 60 ? timeToMin(sl.bed) + 24 * 60 : timeToMin(sl.bed)) / 60
                        ) : null,
                        wake: timeToMin(sl.wake) != null ? (
                            (timeToMin(sl.wake) < 6 * 60 ? timeToMin(sl.wake) + 24 * 60 : timeToMin(sl.wake)) / 60
                        ) : null
                    });
                }
                const N = arr.length;
                const stepX = W / (N - 1);
                // ç”»æ¨ªè½´
                ctx.strokeStyle = document.body.classList.contains("light") ? "rgba(10,20,40,.10)" : "rgba(255,255,255,.10)";
                ctx.beginPath();
                ctx.moveTo(padL, padT + H);
                ctx.lineTo(padL + W, padT + H);
                ctx.stroke();
                // çºµè½´ï¼š18~10ï¼ˆæ¬¡æ—¥ï¼‰å°æ—¶ï¼Œæœ€å¤§åˆ°34ï¼ˆ10ç‚¹ï¼‰
                const minHour = 6, maxHour = 30;
                // ç”»çºµè½´åˆ»åº¦
                ctx.font = "13px sans-serif";
                ctx.fillStyle = "#888";
                ctx.textAlign = "right";
                ctx.textBaseline = "middle";
                for (let h = minHour; h <= maxHour; h += 2) {
                    const y = padT + ((h - minHour) / (maxHour - minHour)) * H;
                    ctx.fillText((h >= 24 ? (h - 24) : h).toString().padStart(2, "0") + ":00", padL - 8, y);
                    ctx.strokeStyle = "#e0e7ef";
                    ctx.beginPath();
                    ctx.moveTo(padL, y);
                    ctx.lineTo(padL + W, y);
                    ctx.stroke();
                }
                // ç”»æŠ˜çº¿
                function drawLine(data, color, fillGrad) {
                    ctx.save();
                    ctx.beginPath();
                    let started = false;
                    for (let i = 0; i < N; i++) {
                        const v = data[i];
                        if (v == null) continue;
                        const x = padL + i * stepX;
                        const y = padT + ((v - minHour) / (maxHour - minHour)) * H;
                        if (!started) { ctx.moveTo(x, y); started = true; }
                        else ctx.lineTo(x, y);
                    }
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2.5;
                    ctx.shadowColor = color + "33";
                    ctx.shadowBlur = 6;
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    ctx.restore();
                    // å¡«å……åŒºåŸŸ
                    if (fillGrad) {
                        ctx.save();
                        ctx.beginPath();
                        started = false;
                        for (let i = 0; i < N; i++) {
                            const v = data[i];
                            if (v == null) continue;
                            const x = padL + i * stepX;
                            const y = padT + ((v - minHour) / (maxHour - minHour)) * H;
                            if (!started) { ctx.moveTo(x, y); started = true; }
                            else ctx.lineTo(x, y);
                        }
                        ctx.lineTo(padL + (N - 1) * stepX, padT + H);
                        ctx.lineTo(padL, padT + H);
                        ctx.closePath();
                        const grad = ctx.createLinearGradient(0, padT, 0, padT + H);
                        grad.addColorStop(0, color + "22");
                        grad.addColorStop(1, color + "03");
                        ctx.fillStyle = grad;
                        ctx.fill();
                        ctx.restore();
                    }
                    // ç”»ç‚¹
                    for (let i = 0; i < N; i++) {
                        const v = data[i];
                        if (v == null) continue;
                        const x = padL + i * stepX;
                        const y = padT + ((v - minHour) / (maxHour - minHour)) * H;
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.globalAlpha = 0.9;
                        ctx.fill();
                        ctx.restore();
                    }
                }
                // ç”»å…¥ç¡çº¿ï¼ˆç´«ï¼‰
                drawLine(arr.map(x => x.bed), "#A78BFA", true);
                // ç”»èµ·åºŠçº¿ï¼ˆç»¿ï¼‰
                drawLine(arr.map(x => x.wake), "#FFCC66", true);
                // æ—¥æœŸæ ‡ç­¾
                ctx.save();
                ctx.font = "12px sans-serif";
                ctx.fillStyle = "#888";
                ctx.textAlign = "center";
                ctx.textBaseline = "top";
                for (let i = 0; i < N; i++) {
                    const x = padL + i * stepX;
                    const label = arr[i].k.slice(5); // MM-DD
                    ctx.fillText(label, x, padT + H + 6);
                }
                ctx.restore();
                // å›¾ä¾‹
                ctx.save();
                ctx.font = "13px sans-serif";
                ctx.textAlign = "left";
                ctx.textBaseline = "middle";

                ctx.fillStyle = "#FFCC66";
                ctx.fillRect(padL + 310, padT - 18, 18, 6);
                ctx.fillStyle = document.body.classList.contains("light") ? "#222" : "#eee";
                ctx.fillText("èµ·åºŠæ—¶é—´", padL + 334, padT - 15);
                ctx.fillStyle = "#A78BFA";
                ctx.fillRect(padL + 410, padT - 18, 18, 6);
                ctx.fillStyle = document.body.classList.contains("light") ? "#222" : "#eee";
                ctx.fillText("å…¥ç¡æ—¶é—´", padL + 434, padT - 15);
                ctx.restore();
                ctx.restore();
            }

            // åœ¨ sleepSave æŒ‰é’®ç‚¹å‡»æ—¶åˆ·æ–°è¯¥ç»Ÿè®¡å›¾
            const sleepSaveBtn = document.getElementById("sleepSave");
            if (sleepSaveBtn) {
                const oldHandler = sleepSaveBtn.onclick;
                sleepSaveBtn.onclick = function () {
                    if (typeof oldHandler === "function") oldHandler.apply(this, arguments);
                    setTimeout(drawSleepTimeLineChart, 100); // æ•°æ®å†™å…¥ååˆ·æ–°
                };
            }
            // é¡µé¢åŠ è½½æ—¶ä¹Ÿç”»ä¸€æ¬¡
            if (document.getElementById("sleepTimeLineChart")) {
                drawSleepTimeLineChart();
            }
            renderTypeOptions(actType, "uncat");
            syncTypeBadge();

            // é¦–æ¬¡æ¸²æŸ“
            renderAllHome();
            renderHabits();
            renderPomodoro();
            renderSleep();
            renderStats();

            // è‡ªåŠ¨å­˜æ¡£åˆå§‹åŒ–ï¼ˆå¼‚æ­¥ï¼‰
            initAutoSync();
        })();
    </script>
</body>

</html>
